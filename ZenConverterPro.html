<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenConverter Pro v3.0 | Safe Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
    <style>
        :root {
            --primary: #000000;
            --accent: #E74C3C;
            --bg: #F5F5F7;
            --surface: #FFFFFF;
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: #333;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: var(--surface);
            width: 90%;
            max-width: 500px;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 { margin: 0 0 10px 0; font-size: 22px; font-weight: 600; }
        .tag { font-size: 11px; background: #eee; padding: 4px 8px; border-radius: 4px; color: #666; font-weight: bold; }

        .upload-box {
            margin-top: 30px;
            border: 2px dashed #DDD;
            border-radius: 12px;
            padding: 40px 20px;
            cursor: pointer;
            position: relative;
            background: #FAFAFA;
            transition: 0.3s;
        }
        
        .upload-box:hover { border-color: var(--accent); background: #FFF; }
        
        input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; font-size: 14px; }
        
        .progress-container { margin-top: 25px; display: none; }
        .bar-bg { width: 100%; height: 6px; background: #EEE; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        .status { margin-top: 10px; font-size: 13px; color: #666; }

        button#downloadBtn {
            margin-top: 20px;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        footer { margin-top: 40px; font-size: 12px; color: #BBB; }
        footer a { color: #BBB; text-decoration: none; }
    </style>
</head>
<body>

    <div class="container">
        <span class="tag">OFFICE 2013 SAFE MODE</span>
        <h1>ZenConverter Pro v3</h1>
        <p style="color:#888; font-size:14px;">ç›¸å®¹æ€§å„ªå…ˆæ¨¡å¼ï¼šé˜²æ­¢èˆŠç‰ˆ Office å£æª”<br>è‡ªå‹•é™é€Ÿè™•ç†ä»¥ç¢ºä¿æª”æ¡ˆçµæ§‹å®Œæ•´</p>

        <div class="upload-box" id="dropZone">
            <div style="font-size:30px; margin-bottom:10px;">ğŸ“„</div>
            <div>é»æ“Šé¸æ“‡æˆ–æ‹–æ›³ PDF</div>
            <input type="file" id="fileInput" accept="application/pdf">
        </div>

        <div class="controls">
            <label><input type="checkbox" id="removeBg"> å»èƒŒæ¨¡å¼ (æ…¢)</label>
            <label><input type="checkbox" id="forceA4" checked> å¼·åˆ¶ A4 ç‰ˆé¢</label>
        </div>

        <div class="progress-container" id="progressBox">
            <div class="bar-bg"><div class="bar-fill" id="barFill"></div></div>
            <div class="status" id="statusText">æº–å‚™ä¸­...</div>
        </div>

        <button id="downloadBtn">ä¸‹è¼‰ PPTX</button>
    </div>

    <footer>Designed by <a href="https://vartanliu.blogspot.com/">Vartan Liu</a></footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const fileInput = document.getElementById('fileInput');
        const statusText = document.getElementById('statusText');
        const barFill = document.getElementById('barFill');
        const progressBox = document.getElementById('progressBox');
        const downloadBtn = document.getElementById('downloadBtn');

        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Reset UI
            downloadBtn.style.display = 'none';
            progressBox.style.display = 'block';
            barFill.style.width = '0%';
            statusText.innerText = "æ­£åœ¨åˆå§‹åŒ–å¼•æ“...";

            try {
                await processPDF(file);
            } catch (err) {
                console.error(err);
                statusText.innerText = "éŒ¯èª¤ï¼š" + err.message;
                statusText.style.color = "red";
            }
        });

        // å¼·åˆ¶å»¶é²å‡½å¼ (é—œéµï¼šè®“ç€è¦½å™¨æœ‰æ™‚é–“é‡‹æ”¾è¨˜æ†¶é«”)
        const delay = ms => new Promise(res => setTimeout(res, ms));

        async function processPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const totalPages = pdf.numPages;

            let pptx = new PptxGenJS();
            
            // è¨­å®šç‰ˆé¢
            const forceA4 = document.getElementById('forceA4').checked;
            if (forceA4) {
                // å¼·åˆ¶è¨­å®šç‚º A4 æ©«å¼ (æ¨™æº–å¯¬é«˜ï¼Œé¿å…å°æ•¸é»èª¤å·®)
                pptx.defineLayout({ name:'A4', width:11.69, height:8.27 });
                pptx.layout = 'A4';
            } else {
                pptx.layout = 'LAYOUT_16x9';
            }

            const isRemoveBg = document.getElementById('removeBg').checked;

            for (let i = 1; i <= totalPages; i++) {
                // æ›´æ–°é€²åº¦
                statusText.innerText = `æ­£åœ¨è™•ç†ç¬¬ ${i} / ${totalPages} é  (å®‰å…¨å¯«å…¥ä¸­)...`;
                barFill.style.width = `${(i / totalPages) * 100}%`;

                // ğŸŒŸ é—œéµä¿®æ­£1ï¼šå¼·åˆ¶ç­‰å¾…ï¼Œé˜²æ­¢ Race Condition
                await delay(300); 

                const page = await pdf.getPage(i);
                
                // ğŸŒŸ é—œéµä¿®æ­£2ï¼šä½¿ç”¨ 1.0 å€ç‡ï¼Œé¿å…åœ–ç‰‡éå¤§æ’çˆ† XML
                const viewport = page.getViewport({ scale: 1.0 });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // ç¹ªè£½ PDF
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                let imgData;
                if (isRemoveBg) {
                    imgData = removeWhiteBg(ctx, canvas.width, canvas.height);
                } else {
                    // ğŸŒŸ é—œéµä¿®æ­£3ï¼šä½¿ç”¨ JPEG 0.7 å“è³ªï¼Œå¹³è¡¡æ¸…æ™°åº¦èˆ‡æª”æ¡ˆå¤§å°
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    imgData = canvas.toDataURL('image/jpeg', 0.7);
                }

                const slide = pptx.addSlide();
                
                // ğŸŒŸ é—œéµä¿®æ­£4ï¼šä½¿ç”¨å–®ç´”çš„å®šä½åƒæ•¸ï¼Œä¸ä½¿ç”¨ç™¾åˆ†æ¯”ï¼Œæ¸›å°‘è¨ˆç®—éŒ¯èª¤
                // å°‡åœ–ç‰‡ "Fit" åˆ°ç‰ˆé¢ä¸­ï¼Œè€Œä¸æ˜¯å¼·åˆ¶æ‹‰ä¼¸
                slide.addImage({
                    data: imgData,
                    x: 0,
                    y: 0,
                    w: '100%',
                    h: '100%',
                    sizing: { type: 'contain', align: 'center' }
                });
            }

            statusText.innerText = "æ‰“åŒ…ä¸­...";
            await delay(500); // æœ€å¾Œå†·å»

            downloadBtn.style.display = 'inline-block';
            statusText.innerText = "è½‰æ›å®Œæˆï¼è«‹ä¸‹è¼‰";
            
            downloadBtn.onclick = () => {
                pptx.writeFile({ 
                    fileName: file.name.replace('.pdf','') + "_Safe.pptx",
                    compression: true // å•Ÿç”¨å£“ç¸®
                });
            };
        }

        function removeWhiteBg(ctx, width, height) {
            const imgData = ctx.getImageData(0, 0, width, height);
            const data = imgData.data;
            // ç°¡åŒ–å»èƒŒé‚è¼¯ä»¥æå‡é€Ÿåº¦
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] > 240 && data[i+1] > 240 && data[i+2] > 240) {
                    data[i+3] = 0;
                }
            }
            ctx.putImageData(imgData, 0, 0);
            return ctx.canvas.toDataURL('image/png');
        }
    </script>
</body>
</html>
