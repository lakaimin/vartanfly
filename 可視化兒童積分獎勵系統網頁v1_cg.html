<!DOCTYPE html>
<html lang='zh-Hant'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>å…’ç«¥å°æ˜Ÿæ˜Ÿç©åˆ†çå‹µç³»çµ±</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #fce3ff, #e3f2ff);
      color: #222;
    }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .app-title {
      font-size: 1.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge-star {
      font-size: 1.6rem;
    }
    .balance {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .balance span.star-icon {
      font-size: 1.4rem;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .tab-btn {
      flex: 1 1 120px;
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      cursor: pointer;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
    }
    .tab-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .tab-btn.active {
      background: #ffcf4a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      font-weight: 600;
    }
    .tab-page { display: none; }
    .tab-page.active { display: block; }

    .layout-two {
      display: flex;
      gap: 16px;
      align-items: stretch;
    }
    .column {
      flex: 1 1 0;
      background: rgba(255,255,255,0.9);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      min-width: 0;
    }
    .column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .column-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .hint-text {
      font-size: 0.8rem;
      color: #666;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-row label {
      font-size: 0.85rem;
      color: #444;
      margin-bottom: 3px;
      display: block;
    }
    .form-group {
      flex: 1 1 120px;
      min-width: 120px;
    }
    input[type='text'],
    input[type='number'] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    input[type='number'] {
      max-width: 100px;
    }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
      gap: 4px;
      max-height: 140px;
      overflow-y: auto;
      padding: 6px;
      background: rgba(248,248,255,0.9);
      border-radius: 12px;
      border: 1px solid #e0e0ff;
    }
    .icon-option {
      border-radius: 10px;
      padding: 6px 0;
      text-align: center;
      cursor: pointer;
      font-size: 1.2rem;
      user-select: none;
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
      background: white;
    }
    .icon-option:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .icon-option.selected {
      background: #ffd54f;
      box-shadow: 0 0 0 2px #ffb300;
    }

    .btn-primary,
    .btn-secondary,
    .btn-danger,
    .btn-ghost {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
    }
    .btn-primary {
      background: #ffb300;
      color: #222;
      font-weight: 600;
    }
    .btn-primary:hover { background: #ffa000; transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.18); }
    .btn-secondary {
      background: #e0e7ff;
      color: #222;
    }
    .btn-secondary:hover { background: #c7d2ff; }
    .btn-danger {
      background: #f97373;
      color: white;
    }
    .btn-danger:hover { background: #ef4444; }
    .btn-ghost {
      background: transparent;
      color: #555;
    }
    .btn-ghost:hover { background: rgba(0,0,0,0.04); }

    .item-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    .item-card {
      background: white;
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      flex: 1 1 auto;
    }
    .item-icon {
      font-size: 1.6rem;
      width: 32px;
      text-align: center;
    }
    .item-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .item-name { font-size: 0.95rem; font-weight: 600; }
    .item-sub { font-size: 0.8rem; color: #666; }
    .item-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    .small-btn {
      border: none;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #eef2ff;
      color: #333;
    }
    .small-btn:hover { background: #e0e7ff; }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .calendar-title {
      font-weight: 600;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      width: 100%;
    }
    .weekday {
      font-size: 0.7rem;
      text-align: center;
      color: #777;
    }
    .calendar-day {
      background: white;
      border-radius: 10px;
      min-height: 42px;
      padding: 4px 2px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid transparent;
      position: relative;
      transition: background 0.1s, transform 0.1s, box-shadow 0.1s, border 0.1s;
    }
    .calendar-day.other-month {
      opacity: 0.28;
    }
    .calendar-day:hover {
      background: #fff7e0;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .calendar-day.selected {
      border-color: #ffb300;
      box-shadow: 0 0 0 2px rgba(255,179,0,0.4);
      background: #fff3c4;
    }
    .calendar-day.today::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #ef4444;
    }
    .day-star-count {
      font-size: 0.65rem;
      margin-top: 2px;
      color: #f59e0b;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .selected-date-info {
      margin-top: 8px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    .shop-card {
      background: white;
      border-radius: 16px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: transform 0.12s, box-shadow 0.12s, background 0.12s;
    }
    .shop-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.14);
      background: #fffaf0;
    }
    .shop-icon {
      font-size: 2rem;
    }
    .shop-name {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .shop-cost {
      font-size: 0.8rem;
      color: #f97316;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-bar {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #555;
      min-height: 1.2em;
    }

    .history-list {
      margin-top: 8px;
      max-height: 360px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .history-item {
      background: white;
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .history-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-icon {
      font-size: 1.4rem;
    }
    .history-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.85rem;
    }
    .history-meta {
      font-size: 0.75rem;
      color: #777;
    }

    .icon-clicked {
      animation: pop 0.2s ease-out;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(0.9); }
      100% { transform: scale(1); }
    }

    @media (max-width: 900px) {
      .layout-two {
        flex-direction: column;
      }
    }
    @media (max-width: 600px) {
      .app-header {
        align-items: flex-start;
      }
      .app-title { font-size: 1.3rem; }
      .calendar-grid { font-size: 0.75rem; }
    }
  </style>
</head>
<body>
  <div class='app-shell'>
    <header class='app-header'>
      <div class='app-title'>
        <span class='badge-star'>ğŸŒŸ</span>
        <span>å°æ˜Ÿæ˜Ÿå…’ç«¥ç©åˆ†çå‹µç³»çµ±</span>
      </div>
      <div class='balance'>
        <span class='star-icon'>â­</span>
        <span>ç›®å‰å¯ç”¨æ˜Ÿæ˜Ÿï¼š</span>
        <span id='totalStars'>0</span>
      </div>
    </header>

    <nav class='tabs'>
      <button class='tab-btn active' data-tab='tasks'>ğŸ“… æ¯æ—¥ä»»å‹™èˆ‡æ—¥æ›†</button>
      <button class='tab-btn' data-tab='rewards'>ğŸª çå‹µæ± èˆ‡çå‹µè¶…å¸‚</button>
      <button class='tab-btn' data-tab='history'>ğŸ“˜ å…Œæ›ç´€éŒ„</button>
    </nav>

    <main>
      <!-- ä»»å‹™ + æ—¥æ›† -->
      <section class='tab-page active' data-page='tasks'>
        <div class='layout-two'>
          <div class='column'>
            <div class='column-header'>
              <div class='column-title'>ğŸ“ æ¯æ—¥ä»»å‹™ç®¡ç†</div>
              <div class='hint-text'>é»æ“Šä»»å‹™å¡ç‰‡ = å¹«å­©å­åŠ æ˜Ÿæ˜Ÿ</div>
            </div>
            <form id='taskForm'>
              <div class='form-row'>
                <div class='form-group'>
                  <label for='taskName'>ä»»å‹™åç¨±</label>
                  <input id='taskName' type='text' placeholder='ä¾‹å¦‚ï¼šæ”¾å­¸å…ˆå¯«å®Œä½œæ¥­' required>
                </div>
                <div class='form-group' style='max-width:110px;'>
                  <label for='taskStars'>æ˜Ÿæ˜Ÿæ•¸</label>
                  <input id='taskStars' type='number' min='1' max='10' value='1' required>
                </div>
              </div>
              <div class='form-row'>
                <div class='form-group' style='flex:1 1 100%;'>
                  <label>ä»»å‹™åœ–æ¨™ï¼ˆé»é¸ä¸€å€‹ï¼‰</label>
                  <div id='taskIconChoices' class='icon-grid'></div>
                </div>
              </div>
              <input type='hidden' id='taskIcon'>
              <input type='hidden' id='taskEditingId'>
              <div class='form-row'>
                <button type='submit' class='btn-primary'>ğŸ’¾ å„²å­˜ä»»å‹™</button>
                <button type='button' id='taskCancelEdit' class='btn-ghost'>å–æ¶ˆç·¨è¼¯</button>
              </div>
            </form>
            <div class='item-list' id='taskList'></div>
          </div>

          <div class='column'>
            <div class='column-header'>
              <div class='column-title'>ğŸ“… æ˜Ÿæ˜Ÿæ—¥æ›†</div>
              <div class='hint-text'>å¯åˆ‡æ›æœˆä»½ã€æŸ¥çœ‹æ­·å²æ˜Ÿæ˜Ÿç´€éŒ„</div>
            </div>
            <div class='calendar-header'>
              <button type='button' class='btn-secondary' id='prevMonth'>â† ä¸Šä¸€å€‹æœˆ</button>
              <div class='calendar-title' id='calendarTitle'></div>
              <button type='button' class='btn-secondary' id='nextMonth'>ä¸‹ä¸€å€‹æœˆ â†’</button>
            </div>
            <div class='calendar-grid' id='calendarGrid'></div>
            <div class='selected-date-info'>
              <div>ç›®å‰é¸æ“‡æ—¥æœŸï¼š<span id='selectedDateText'>--</span></div>
              <div>ç•¶å¤©ç²å¾—æ˜Ÿæ˜Ÿï¼š<span id='selectedDateStars'>0</span> é¡†</div>
            </div>
          </div>
        </div>
      </section>

      <!-- çå‹µæ±  + è¶…å¸‚ -->
      <section class='tab-page' data-page='rewards'>
        <div class='layout-two'>
          <div class='column'>
            <div class='column-header'>
              <div class='column-title'>ğŸ§° çå‹µæ± ç®¡ç†</div>
              <div class='hint-text'>è¨­å®šå¯ä»¥å…Œæ›çš„çå“èˆ‡æ‰€éœ€æ˜Ÿæ˜Ÿ</div>
            </div>
            <form id='rewardForm'>
              <div class='form-row'>
                <div class='form-group'>
                  <label for='rewardName'>çå“åç¨±</label>
                  <input id='rewardName' type='text' placeholder='ä¾‹å¦‚ï¼šä¸€èµ·å»çœ‹é›»å½±' required>
                </div>
                <div class='form-group' style='max-width:110px;'>
                  <label for='rewardCost'>éœ€è¦æ˜Ÿæ˜Ÿ</label>
                  <input id='rewardCost' type='number' min='1' max='999' value='5' required>
                </div>
              </div>
              <div class='form-row'>
                <div class='form-group' style='flex:1 1 100%;'>
                  <label>çå‹µåœ–æ¨™ï¼ˆé»é¸ä¸€å€‹ï¼‰</label>
                  <div id='rewardIconChoices' class='icon-grid'></div>
                </div>
              </div>
              <input type='hidden' id='rewardIcon'>
              <input type='hidden' id='rewardEditingId'>
              <div class='form-row'>
                <button type='submit' class='btn-primary'>ğŸ’¾ å„²å­˜çå“</button>
                <button type='button' id='rewardCancelEdit' class='btn-ghost'>å–æ¶ˆç·¨è¼¯</button>
              </div>
            </form>
            <div class='item-list' id='rewardList'></div>
          </div>

          <div class='column'>
            <div class='column-header'>
              <div class='column-title'>ğŸª å­©å­çš„çå‹µè¶…å¸‚</div>
              <div class='hint-text'>é»æ“Šçå“å…Œæ›æ˜Ÿæ˜Ÿï¼Œä¸æœƒè·³å‡ºè¦–çª—</div>
            </div>
            <div>ç›®å‰æ˜Ÿæ˜Ÿï¼š<strong id='shopStars'>0</strong> é¡†</div>
            <div class='status-bar' id='shopStatus'></div>
            <div class='shop-grid' id='rewardShop'></div>
          </div>
        </div>
      </section>

      <!-- å…Œæ›ç´€éŒ„ -->
      <section class='tab-page' data-page='history'>
        <div class='column'>
          <div class='column-header'>
            <div class='column-title'>ğŸ“˜ å…Œæ›ç´€éŒ„</div>
            <button type='button' id='clearHistory' class='btn-danger'>æ¸…é™¤å…¨éƒ¨ç´€éŒ„</button>
          </div>
          <div class='hint-text'>è¨˜éŒ„æ¯ä¸€æ¬¡æ˜Ÿæ˜Ÿå…Œæ›çš„æ—¥æœŸã€æ™‚é–“èˆ‡çå“å…§å®¹ã€‚</div>
          <div class='history-list' id='historyList'></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --------- è³‡æ–™æ¨¡å‹èˆ‡å¸¸æ•¸ ---------
    var taskIcons = [
      'ğŸ“š','âœï¸','ğŸ“','ğŸ“–','ğŸ§ ',
      'ğŸ§¹','ğŸ§º','ğŸ§¼','ğŸ§½','ğŸ›ï¸',
      'ğŸ§¸','ğŸ½ï¸','ğŸš®','ğŸ¶','ğŸ±',
      'ğŸš¿','ğŸª¥','ğŸ§´','ğŸŒ™','ğŸ˜´',
      'ğŸš²','ğŸƒ','ğŸ§’','ğŸ‘§','ğŸ‘¦'
    ];

    // è‡³å°‘ 30 å€‹çå‹µè¶…å¸‚åœ–æ¨™
    var rewardIcons = [
      'ğŸ…','ğŸ–ï¸','ğŸ','ğŸˆ','â­',
      'ğŸ§¸','ğŸš—','ğŸš‚','ğŸ®','ğŸ“º',
      'ğŸ¿','ğŸ•','ğŸ¦','ğŸ­','ğŸ°',
      'ğŸ¢','ğŸ¡','ğŸ ','ğŸ³','ğŸ¯',
      'ğŸ¨','ğŸ“š','ğŸ§','ğŸ¤','ğŸŸï¸',
      'ğŸ¶','ğŸ±','ğŸ¼','ğŸš´â€â™‚ï¸','ğŸŠâ€â™€ï¸',
      'ğŸ¬','ğŸ›','ğŸ–ï¸','ğŸ›¤ï¸','ğŸ’¤'
    ];

    var tasks = [];
    var rewards = [];
    var calendarStars = {}; // dateStr -> { earned: number }
    var totalStars = 0;
    var redemptionHistory = [];
    var selectedDateStr = '';

    var STORAGE_KEYS = {
      tasks: 'kidsTasks',
      rewards: 'kidsRewards',
      calendar: 'kidsCalendarStars',
      total: 'kidsTotalStars',
      history: 'kidsRedemptionHistory'
    };

    function saveAll() {
      localStorage.setItem(STORAGE_KEYS.tasks, JSON.stringify(tasks));
      localStorage.setItem(STORAGE_KEYS.rewards, JSON.stringify(rewards));
      localStorage.setItem(STORAGE_KEYS.calendar, JSON.stringify(calendarStars));
      localStorage.setItem(STORAGE_KEYS.total, String(totalStars));
      localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(redemptionHistory));
    }

    function loadAll() {
      try {
        var t = localStorage.getItem(STORAGE_KEYS.tasks);
        var r = localStorage.getItem(STORAGE_KEYS.rewards);
        var c = localStorage.getItem(STORAGE_KEYS.calendar);
        var s = localStorage.getItem(STORAGE_KEYS.total);
        var h = localStorage.getItem(STORAGE_KEYS.history);
        tasks = t ? JSON.parse(t) : [];
        rewards = r ? JSON.parse(r) : [];
        calendarStars = c ? JSON.parse(c) : {};
        totalStars = s ? parseInt(s, 10) || 0 : 0;
        redemptionHistory = h ? JSON.parse(h) : [];
      } catch (e) {
        tasks = [];
        rewards = [];
        calendarStars = {};
        totalStars = 0;
        redemptionHistory = [];
      }

      // è‹¥æ²’æœ‰ä»»ä½•è³‡æ–™ï¼Œå»ºç«‹å¹¾å€‹é è¨­
      if (!tasks || tasks.length === 0) {
        tasks = [
          { id: generateId(), name: 'æ”¾å­¸å…ˆå®Œæˆä½œæ¥­', icon: 'ğŸ“š', stars: 2 },
          { id: generateId(), name: 'å¹«å¿™æ”¶ç©å…·èˆ‡æ•´ç†æˆ¿é–“', icon: 'ğŸ§¸', stars: 1 },
          { id: generateId(), name: 'æ™šä¸Šæº–æ™‚ä¸ŠåºŠç¡è¦º', icon: 'ğŸŒ™', stars: 2 }
        ];
      }
      if (!rewards || rewards.length === 0) {
        rewards = [
          { id: generateId(), name: 'ä¸€èµ·çœ‹ä¸€éƒ¨é›»å½±', icon: 'ğŸ¬', cost: 8 },
          { id: generateId(), name: 'å‡æ—¥å»å…¬åœ’ç©', icon: 'ğŸ›', cost: 6 },
          { id: generateId(), name: 'æŒ‘ä¸€å€‹å°ç©å…·', icon: 'ğŸ§¸', cost: 10 }
        ];
      }
    }

    function generateId() {
      return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function formatDate(date) {
      var y = date.getFullYear();
      var m = (date.getMonth() + 1).toString().padStart(2, '0');
      var d = date.getDate().toString().padStart(2, '0');
      return y + '-' + m + '-' + d;
    }

    function formatDateHuman(date) {
      var y = date.getFullYear();
      var m = date.getMonth() + 1;
      var d = date.getDate();
      return y + ' / ' + m + ' / ' + d;
    }

    function formatDateStrHuman(dateStr) {
      if (!dateStr) return '--';
      var parts = dateStr.split('-');
      if (parts.length !== 3) return dateStr;
      return parts[0] + ' / ' + parseInt(parts[1], 10) + ' / ' + parseInt(parts[2], 10);
    }

    function formatDateTime(dt) {
      var y = dt.getFullYear();
      var m = (dt.getMonth() + 1).toString().padStart(2, '0');
      var d = dt.getDate().toString().padStart(2, '0');
      var hh = dt.getHours().toString().padStart(2, '0');
      var mm = dt.getMinutes().toString().padStart(2, '0');
      return y + '-' + m + '-' + d + ' ' + hh + ':' + mm;
    }

    // --------- UI æ›´æ–° ---------
    function updateStarDisplays() {
      var totalEl = document.getElementById('totalStars');
      var shopEl = document.getElementById('shopStars');
      if (totalEl) totalEl.textContent = totalStars;
      if (shopEl) shopEl.textContent = totalStars;
      updateSelectedDateInfo();
      renderCalendar(currentYear, currentMonth);
    }

    function updateSelectedDateInfo() {
      var dateTextEl = document.getElementById('selectedDateText');
      var dateStarsEl = document.getElementById('selectedDateStars');
      if (!selectedDateStr) {
        dateTextEl.textContent = '--';
        dateStarsEl.textContent = '0';
        return;
      }
      dateTextEl.textContent = formatDateStrHuman(selectedDateStr);
      var info = calendarStars[selectedDateStr];
      var value = info && typeof info.earned === 'number' ? info.earned : 0;
      dateStarsEl.textContent = value;
    }

    function renderTaskIconChoices() {
      var container = document.getElementById('taskIconChoices');
      container.innerHTML = '';
      taskIcons.forEach(function(icon, index) {
        var div = document.createElement('div');
        div.className = 'icon-option';
        div.textContent = icon;
        div.dataset.icon = icon;
        div.addEventListener('click', function() {
          selectIcon(container, div, 'taskIcon');
        });
        container.appendChild(div);
        if (index === 0) {
          // é è¨­é¸ç¬¬ä¸€å€‹
          selectIcon(container, div, 'taskIcon');
        }
      });
    }

    function renderRewardIconChoices() {
      var container = document.getElementById('rewardIconChoices');
      container.innerHTML = '';
      rewardIcons.forEach(function(icon, index) {
        var div = document.createElement('div');
        div.className = 'icon-option';
        div.textContent = icon;
        div.dataset.icon = icon;
        div.addEventListener('click', function() {
          selectIcon(container, div, 'rewardIcon');
        });
        container.appendChild(div);
        if (index === 0) {
          selectIcon(container, div, 'rewardIcon');
        }
      });
    }

    function selectIcon(container, element, hiddenInputId) {
      var options = container.querySelectorAll('.icon-option');
      options.forEach(function(opt) { opt.classList.remove('selected'); });
      element.classList.add('selected');
      var hidden = document.getElementById(hiddenInputId);
      if (hidden) hidden.value = element.dataset.icon;
      flashClick(element);
    }

    function renderTaskList() {
      var listEl = document.getElementById('taskList');
      listEl.innerHTML = '';
      tasks.forEach(function(task) {
        var card = document.createElement('div');
        card.className = 'item-card';

        var main = document.createElement('div');
        main.className = 'item-main';
        main.addEventListener('click', function(ev) {
          // è‹¥é»æ“Šçš„æ˜¯ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•å°±ä¸è¦åŠ æ˜Ÿæ˜Ÿ
          if (ev.target.closest('.small-btn')) return;
          handleTaskEarn(task, main);
        });

        var iconSpan = document.createElement('div');
        iconSpan.className = 'item-icon';
        iconSpan.textContent = task.icon || 'â­';

        var textDiv = document.createElement('div');
        textDiv.className = 'item-text';
        var nameDiv = document.createElement('div');
        nameDiv.className = 'item-name';
        nameDiv.textContent = task.name;
        var subDiv = document.createElement('div');
        subDiv.className = 'item-sub';
        subDiv.textContent = 'å®Œæˆä¸€æ¬¡ + ' + task.stars + ' é¡†æ˜Ÿæ˜Ÿ';
        textDiv.appendChild(nameDiv);
        textDiv.appendChild(subDiv);

        main.appendChild(iconSpan);
        main.appendChild(textDiv);

        var actions = document.createElement('div');
        actions.className = 'item-actions';

        var editBtn = document.createElement('button');
        editBtn.className = 'small-btn';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.addEventListener('click', function() {
          loadTaskIntoForm(task);
        });

        var delBtn = document.createElement('button');
        delBtn.className = 'small-btn';
        delBtn.textContent = 'åˆªé™¤';
        delBtn.addEventListener('click', function() {
          if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ')) {
            tasks = tasks.filter(function(t) { return t.id !== task.id; });
            saveAll();
            renderTaskList();
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        card.appendChild(main);
        card.appendChild(actions);
        listEl.appendChild(card);
      });
    }

    function handleTaskEarn(task, element) {
      if (!selectedDateStr) {
        // è‹¥å°šæœªé¸æ—¥æœŸï¼Œå°±é è¨­ä»Šå¤©
        var today = new Date();
        selectedDateStr = formatDate(today);
      }
      if (!calendarStars[selectedDateStr]) {
        calendarStars[selectedDateStr] = { earned: 0 };
      }
      calendarStars[selectedDateStr].earned += Number(task.stars) || 0;
      totalStars += Number(task.stars) || 0;
      saveAll();
      flashClick(element);
      updateStarDisplays();
    }

    function loadTaskIntoForm(task) {
      document.getElementById('taskName').value = task.name;
      document.getElementById('taskStars').value = task.stars;
      document.getElementById('taskEditingId').value = task.id;
      // è¨­å®š icon é¸æ“‡
      var container = document.getElementById('taskIconChoices');
      var options = container.querySelectorAll('.icon-option');
      options.forEach(function(opt) {
        if (opt.dataset.icon === task.icon) {
          selectIcon(container, opt, 'taskIcon');
        }
      });
    }

    function resetTaskForm() {
      document.getElementById('taskName').value = '';
      document.getElementById('taskStars').value = 1;
      document.getElementById('taskEditingId').value = '';
      var container = document.getElementById('taskIconChoices');
      var first = container.querySelector('.icon-option');
      if (first) selectIcon(container, first, 'taskIcon');
    }

    function renderRewardList() {
      var listEl = document.getElementById('rewardList');
      listEl.innerHTML = '';
      rewards.forEach(function(reward) {
        var card = document.createElement('div');
        card.className = 'item-card';

        var main = document.createElement('div');
        main.className = 'item-main';

        var iconSpan = document.createElement('div');
        iconSpan.className = 'item-icon';
        iconSpan.textContent = reward.icon || 'ğŸ';

        var textDiv = document.createElement('div');
        textDiv.className = 'item-text';
        var nameDiv = document.createElement('div');
        nameDiv.className = 'item-name';
        nameDiv.textContent = reward.name;
        var subDiv = document.createElement('div');
        subDiv.className = 'item-sub';
        subDiv.textContent = 'å…Œæ›éœ€è¦ ' + reward.cost + ' é¡†æ˜Ÿæ˜Ÿ';
        textDiv.appendChild(nameDiv);
        textDiv.appendChild(subDiv);

        main.appendChild(iconSpan);
        main.appendChild(textDiv);

        var actions = document.createElement('div');
        actions.className = 'item-actions';

        var editBtn = document.createElement('button');
        editBtn.className = 'small-btn';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.addEventListener('click', function() {
          loadRewardIntoForm(reward);
        });

        var delBtn = document.createElement('button');
        delBtn.className = 'small-btn';
        delBtn.textContent = 'åˆªé™¤';
        delBtn.addEventListener('click', function() {
          if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹çå“å—ï¼Ÿ')) {
            rewards = rewards.filter(function(r) { return r.id !== reward.id; });
            saveAll();
            renderRewardList();
            renderRewardShop();
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        card.appendChild(main);
        card.appendChild(actions);
        listEl.appendChild(card);
      });
    }

    function loadRewardIntoForm(reward) {
      document.getElementById('rewardName').value = reward.name;
      document.getElementById('rewardCost').value = reward.cost;
      document.getElementById('rewardEditingId').value = reward.id;
      var container = document.getElementById('rewardIconChoices');
      var options = container.querySelectorAll('.icon-option');
      options.forEach(function(opt) {
        if (opt.dataset.icon === reward.icon) {
          selectIcon(container, opt, 'rewardIcon');
        }
      });
    }

    function resetRewardForm() {
      document.getElementById('rewardName').value = '';
      document.getElementById('rewardCost').value = 5;
      document.getElementById('rewardEditingId').value = '';
      var container = document.getElementById('rewardIconChoices');
      var first = container.querySelector('.icon-option');
      if (first) selectIcon(container, first, 'rewardIcon');
    }

    function renderRewardShop() {
      var shopEl = document.getElementById('rewardShop');
      shopEl.innerHTML = '';
      rewards.forEach(function(reward) {
        var card = document.createElement('div');
        card.className = 'shop-card';

        var iconDiv = document.createElement('div');
        iconDiv.className = 'shop-icon';
        iconDiv.textContent = reward.icon || 'ğŸ';

        var nameDiv = document.createElement('div');
        nameDiv.className = 'shop-name';
        nameDiv.textContent = reward.name;

        var costDiv = document.createElement('div');
        costDiv.className = 'shop-cost';
        costDiv.innerHTML = '<span>â­</span><span>' + reward.cost + ' é¡†</span>';

        card.appendChild(iconDiv);
        card.appendChild(nameDiv);
        card.appendChild(costDiv);

        card.addEventListener('click', function() {
          handleRewardRedeem(reward, card);
        });

        shopEl.appendChild(card);
      });
    }

    function handleRewardRedeem(reward, element) {
      var statusEl = document.getElementById('shopStatus');
      if (totalStars < reward.cost) {
        statusEl.textContent = 'æ˜Ÿæ˜Ÿä¸å¤ ï¼Œé‚„å·® ' + (reward.cost - totalStars) + ' é¡†ï¼Œå¯ä»¥å†å¤šåšå¹¾ä»¶å¥½äº‹å–”ï¼';
        flashClick(element);
        return;
      }
      totalStars -= reward.cost;
      var now = new Date();
      redemptionHistory.unshift({
        id: generateId(),
        name: reward.name,
        icon: reward.icon,
        cost: reward.cost,
        datetime: formatDateTime(now)
      });
      saveAll();
      flashClick(element);
      statusEl.textContent = 'å·²æˆåŠŸå…Œæ›ã€Œ' + reward.name + 'ã€ï¼Œè¨˜éŒ„å·²å­˜å…¥å…Œæ›ç´€éŒ„ã€‚';
      updateStarDisplays();
      renderHistory();
    }

    function renderHistory() {
      var listEl = document.getElementById('historyList');
      listEl.innerHTML = '';
      if (!redemptionHistory || redemptionHistory.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'hint-text';
        empty.style.marginTop = '8px';
        empty.textContent = 'ç›®å‰é‚„æ²’æœ‰å…Œæ›ç´€éŒ„ï¼Œå…ˆåœ¨çå‹µè¶…å¸‚æŒ‘é¸çå“å§ï¼';
        listEl.appendChild(empty);
        return;
      }
      redemptionHistory.forEach(function(rec) {
        var item = document.createElement('div');
        item.className = 'history-item';

        var main = document.createElement('div');
        main.className = 'history-main';

        var iconDiv = document.createElement('div');
        iconDiv.className = 'history-icon';
        iconDiv.textContent = rec.icon || 'ğŸ';

        var textDiv = document.createElement('div');
        textDiv.className = 'history-text';

        var titleDiv = document.createElement('div');
        titleDiv.textContent = 'å…Œæ›ã€Œ' + rec.name + 'ã€ - ä½¿ç”¨ ' + rec.cost + ' é¡†æ˜Ÿæ˜Ÿ';

        var metaDiv = document.createElement('div');
        metaDiv.className = 'history-meta';
        metaDiv.textContent = rec.datetime;

        textDiv.appendChild(titleDiv);
        textDiv.appendChild(metaDiv);

        main.appendChild(iconDiv);
        main.appendChild(textDiv);

        var starsDiv = document.createElement('div');
        starsDiv.className = 'history-meta';
        starsDiv.textContent = 'â­-' + rec.cost;

        item.appendChild(main);
        item.appendChild(starsDiv);
        listEl.appendChild(item);
      });
    }

    function flashClick(element) {
      element.classList.remove('icon-clicked');
      // è§¸ç™¼é‡æ’­å‹•ç•«
      void element.offsetWidth;
      element.classList.add('icon-clicked');
    }

    // --------- æ—¥æ›† ---------
    var currentYear, currentMonth;

    function initCalendar() {
      var today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth(); // 0-based
      selectedDateStr = formatDate(today);
      renderCalendar(currentYear, currentMonth);
      updateSelectedDateInfo();
    }

    function renderCalendar(year, month) {
      var grid = document.getElementById('calendarGrid');
      var titleEl = document.getElementById('calendarTitle');
      grid.innerHTML = '';

      var monthNames = ['1 æœˆ','2 æœˆ','3 æœˆ','4 æœˆ','5 æœˆ','6 æœˆ','7 æœˆ','8 æœˆ','9 æœˆ','10 æœˆ','11 æœˆ','12 æœˆ'];
      titleEl.textContent = year + ' å¹´ ' + monthNames[month];

      var weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      weekdays.forEach(function(w) {
        var wEl = document.createElement('div');
        wEl.className = 'weekday';
        wEl.textContent = w;
        grid.appendChild(wEl);
      });

      var firstDay = new Date(year, month, 1);
      var startingWeekday = firstDay.getDay();
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var prevMonthDays = new Date(year, month, 0).getDate();

      // å‰ä¸€å€‹æœˆçš„ç©ºæ ¼
      for (var i = 0; i < startingWeekday; i++) {
        var dayNum = prevMonthDays - startingWeekday + 1 + i;
        var dateStrPrev = formatDate(new Date(year, month - 1, dayNum));
        grid.appendChild(createDayCell(dayNum, dateStrPrev, true));
      }

      // ç•¶æœˆ
      for (var d = 1; d <= daysInMonth; d++) {
        var dateStr = formatDate(new Date(year, month, d));
        grid.appendChild(createDayCell(d, dateStr, false));
      }

      var cellsCount = startingWeekday + daysInMonth;
      var nextDays = (7 - (cellsCount % 7)) % 7;
      for (var j = 1; j <= nextDays; j++) {
        var dateStrNext = formatDate(new Date(year, month + 1, j));
        grid.appendChild(createDayCell(j, dateStrNext, true));
      }

      highlightSelectedDateCell();
    }

    function createDayCell(dayNumber, dateStr, isOtherMonth) {
      var cell = document.createElement('button');
      cell.type = 'button';
      cell.className = 'calendar-day';
      if (isOtherMonth) cell.classList.add('other-month');
      cell.dataset.date = dateStr;
      cell.textContent = dayNumber;

      var info = calendarStars[dateStr];
      var value = info && typeof info.earned === 'number' ? info.earned : 0;
      if (value > 0) {
        var starDiv = document.createElement('div');
        starDiv.className = 'day-star-count';
        starDiv.innerHTML = 'â­ ' + value;
        cell.appendChild(starDiv);
      }

      var todayStr = formatDate(new Date());
      if (dateStr === todayStr) {
        cell.classList.add('today');
      }

      cell.addEventListener('click', function() {
        selectedDateStr = dateStr;
        updateSelectedDateInfo();
        highlightSelectedDateCell();
      });

      return cell;
    }

    function highlightSelectedDateCell() {
      var grid = document.getElementById('calendarGrid');
      var cells = grid.querySelectorAll('.calendar-day');
      cells.forEach(function(c) {
        if (c.dataset.date === selectedDateStr) {
          c.classList.add('selected');
        } else {
          c.classList.remove('selected');
        }
      });
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear -= 1;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear += 1;
      }
      renderCalendar(currentYear, currentMonth);
      highlightSelectedDateCell();
    }

    // --------- åˆ†é åˆ‡æ› ---------
    function initTabs() {
      var tabButtons = document.querySelectorAll('.tab-btn');
      var pages = document.querySelectorAll('.tab-page');
      tabButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var tab = btn.dataset.tab;
          tabButtons.forEach(function(b) { b.classList.remove('active'); });
          pages.forEach(function(p) { p.classList.remove('active'); });
          btn.classList.add('active');
          var page = document.querySelector(".tab-page[data-page='" + tab + "']");
          if (page) page.classList.add('active');
        });
      });
    }

    // --------- äº‹ä»¶èˆ‡åˆå§‹åŒ– ---------
    document.addEventListener('DOMContentLoaded', function() {
      loadAll();
      renderTaskIconChoices();
      renderRewardIconChoices();
      renderTaskList();
      renderRewardList();
      renderRewardShop();
      renderHistory();
      initTabs();
      initCalendar();
      updateStarDisplays();

      document.getElementById('prevMonth').addEventListener('click', function() {
        changeMonth(-1);
      });
      document.getElementById('nextMonth').addEventListener('click', function() {
        changeMonth(1);
      });

      document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var name = document.getElementById('taskName').value.trim();
        var stars = parseInt(document.getElementById('taskStars').value, 10) || 1;
        var icon = document.getElementById('taskIcon').value || 'â­';
        var editId = document.getElementById('taskEditingId').value;
        if (!name) return;
        if (editId) {
          tasks = tasks.map(function(t) {
            if (t.id === editId) {
              return { id: t.id, name: name, icon: icon, stars: stars };
            }
            return t;
          });
        } else {
          tasks.push({ id: generateId(), name: name, icon: icon, stars: stars });
        }
        saveAll();
        renderTaskList();
        resetTaskForm();
      });

      document.getElementById('taskCancelEdit').addEventListener('click', function() {
        resetTaskForm();
      });

      document.getElementById('rewardForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var name = document.getElementById('rewardName').value.trim();
        var cost = parseInt(document.getElementById('rewardCost').value, 10) || 1;
        var icon = document.getElementById('rewardIcon').value || 'ğŸ';
        var editId = document.getElementById('rewardEditingId').value;
        if (!name) return;
        if (editId) {
          rewards = rewards.map(function(r) {
            if (r.id === editId) {
              return { id: r.id, name: name, icon: icon, cost: cost };
            }
            return r;
          });
        } else {
          rewards.push({ id: generateId(), name: name, icon: icon, cost: cost });
        }
        saveAll();
        renderRewardList();
        renderRewardShop();
        resetRewardForm();
      });

      document.getElementById('rewardCancelEdit').addEventListener('click', function() {
        resetRewardForm();
      });

      document.getElementById('clearHistory').addEventListener('click', function() {
        if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å…Œæ›ç´€éŒ„å—ï¼Ÿ')) return;
        redemptionHistory = [];
        saveAll();
        renderHistory();
      });
    });
  </script>
</body>
</html>