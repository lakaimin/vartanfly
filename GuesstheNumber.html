<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Logic 1A2B | 3D Puzzle Game</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs (Compat Version for Stability) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Rajdhani', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .history-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .history-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .history-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 4px;
        }

        .glass-panel {
            background: rgba(13, 17, 23, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        .glass-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }

        .text-neon-blue {
            color: #00f3ff;
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
        }
        .text-neon-gold {
            color: #ffd700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        #ui-layer {
            position: relative;
            z-index: 10;
            height: 100%; 
            height: 100dvh; 
            display: flex;
            flex-direction: column;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .pb-safe-area {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase Initialization (Compat) ---
        const firebaseConfig = JSON.parse(__firebase_config);
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const { useState, useEffect, useRef } = React;

        // --- Utils ---
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // --- 3D Background System ---
        const ThreeBackground = ({ gameState }) => {
            const mountRef = useRef(null);
            
            useEffect(() => {
                const scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x050510, 0.035);

                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                mountRef.current.appendChild(renderer.domElement);

                // Core
                const geometry = new THREE.IcosahedronGeometry(1.5, 1);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0x00f3ff, wireframe: true, transparent: true, opacity: 0.3
                });
                const core = new THREE.Mesh(geometry, material);
                scene.add(core);

                const innerGeo = new THREE.IcosahedronGeometry(0.8, 0);
                const innerMat = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                const innerCore = new THREE.Mesh(innerGeo, innerMat);
                core.add(innerCore);

                // Particles
                const particlesGeo = new THREE.BufferGeometry();
                const particlesCount = 300;
                const posArray = new Float32Array(particlesCount * 3);
                for(let i = 0; i < particlesCount * 3; i++) posArray[i] = (Math.random() - 0.5) * 15; 
                particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: 0xffffff, transparent: true, opacity: 0.8 });
                const particlesMesh = new THREE.Points(particlesGeo, particlesMat);
                scene.add(particlesMesh);

                const pointLight = new THREE.PointLight(0x00f3ff, 1, 100);
                pointLight.position.set(2, 2, 2);
                scene.add(pointLight);

                let frameId;
                const animate = () => {
                    frameId = requestAnimationFrame(animate);
                    if (core) {
                        core.rotation.x += 0.002;
                        core.rotation.y += 0.005;
                        if (gameState === 'won') {
                            core.rotation.x += 0.05;
                            core.rotation.y += 0.05;
                            core.scale.setScalar(1.0 + Math.sin(Date.now() * 0.005) * 0.2);
                            material.color.setHex(0xffd700); 
                        } else {
                            core.scale.setScalar(1);
                            material.color.setHex(0x00f3ff);
                        }
                    }
                    if (particlesMesh) particlesMesh.rotation.y -= 0.001;
                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    cancelAnimationFrame(frameId);
                    window.removeEventListener('resize', handleResize);
                    mountRef.current.removeChild(renderer.domElement);
                    geometry.dispose();
                    material.dispose();
                };
            }, [gameState]);

            return <div ref={mountRef} className="absolute inset-0 z-0 pointer-events-none" />;
        };

        // --- Hooks ---
        const useGameLogic = () => {
            const [secret, setSecret] = useState([]);
            const [history, setHistory] = useState([]); 
            const [gameState, setGameState] = useState('playing'); // playing, won
            const [showRules, setShowRules] = useState(true);
            
            // Timer State
            const [timer, setTimer] = useState(0);
            const timerRef = useRef(null);

            const stopTimer = () => {
                if (timerRef.current) clearInterval(timerRef.current);
            };

            const startNewGame = () => {
                stopTimer();
                setTimer(0);
                
                const nums = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                const newSecret = [];
                for (let i = 0; i < 4; i++) {
                    const index = Math.floor(Math.random() * nums.length);
                    newSecret.push(nums[index]);
                    nums.splice(index, 1);
                }
                setSecret(newSecret);
                setHistory([]);
                setGameState('playing');
                console.log("Secret:", newSecret.join(''));

                // Start Timer
                timerRef.current = setInterval(() => {
                    setTimer(prev => prev + 1);
                }, 1000);
            };

            // Cleanup timer on unmount
            useEffect(() => {
                return () => stopTimer();
            }, []);

            // Init game once
            useEffect(() => {
                startNewGame();
            }, []);

            const submitGuess = (guessArr) => {
                let a = 0;
                let b = 0;
                
                guessArr.forEach((num, idx) => {
                    if (num === secret[idx]) a++;
                    else if (secret.includes(num)) b++;
                });

                setHistory([{ guess: guessArr.join(''), a, b }, ...history]);

                if (a === 4) {
                    setGameState('won');
                    stopTimer();
                }
            };

            // Fixed: Return setGameState so App can use it
            return { secret, history, gameState, setGameState, startNewGame, submitGuess, showRules, setShowRules, timer };
        };

        // --- UI Components ---
        const Keypad = ({ onInput, onDelete, onSubmit, currentInput, disabled }) => {
            const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0];
            return (
                <div className="grid grid-cols-3 gap-3 p-4 max-w-sm mx-auto w-full">
                    {nums.map(num => {
                        const isUsed = currentInput.includes(num);
                        return (
                            <button
                                key={num}
                                onClick={() => onInput(num)}
                                disabled={disabled || isUsed}
                                className={`glass-btn h-14 rounded-xl text-2xl font-bold flex items-center justify-center 
                                    ${isUsed ? 'opacity-30 cursor-not-allowed' : 'hover:bg-white/10 text-white'}
                                    ${num === 0 ? 'col-start-2' : ''}
                                `}
                            >
                                {num}
                            </button>
                        );
                    })}
                    <button onClick={onDelete} className="glass-btn h-14 rounded-xl flex items-center justify-center text-red-400 col-start-3 row-start-4 active:text-red-200">
                        <i data-lucide="delete" className="w-6 h-6"></i>
                    </button>
                     <button onClick={onSubmit} disabled={currentInput.length !== 4 || disabled}
                        className={`h-14 rounded-xl flex items-center justify-center font-bold text-lg transition-all col-start-1 row-start-4
                            ${currentInput.length === 4 && !disabled ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-[0_0_15px_rgba(0,255,255,0.5)]' : 'glass-btn opacity-50 cursor-not-allowed text-gray-400'}
                        `}>
                        ENTER
                    </button>
                </div>
            );
        };

        const GuessRow = ({ guess, a, b, isLatest }) => (
            <div className={`flex items-center justify-between p-3 mb-2 rounded-lg border border-white/5 ${isLatest ? 'bg-white/10 border-cyan-500/30' : 'bg-black/20'}`}>
                <div className="font-mono text-2xl tracking-widest text-white/90">{guess}</div>
                <div className="flex gap-3">
                    <span className="flex items-center gap-1 font-bold text-neon-gold">{a}<span className="text-xs opacity-70">A</span></span>
                    <span className="flex items-center gap-1 font-bold text-neon-blue">{b}<span className="text-xs opacity-70">B</span></span>
                </div>
            </div>
        );

        // --- Leaderboard Modal ---
        const LeaderboardModal = ({ onClose, user }) => {
            const [scores, setScores] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) return;
                const fetchScores = async () => {
                    try {
                        // Compat Syntax: db.collection(...)
                        const leaderboardRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard');
                        const querySnapshot = await leaderboardRef.get();
                        
                        const fetchedScores = [];
                        querySnapshot.forEach((doc) => {
                            fetchedScores.push({ id: doc.id, ...doc.data() });
                        });
                        
                        fetchedScores.sort((a, b) => a.time - b.time);
                        setScores(fetchedScores.slice(0, 10)); // Top 10
                    } catch (err) {
                        console.error("Error fetching scores:", err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchScores();
            }, [user]);

            return (
                 <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in">
                    <div className="glass-panel p-6 rounded-2xl max-w-sm w-full relative flex flex-col max-h-[80vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                            <i data-lucide="x" className="w-6 h-6"></i>
                        </button>
                        
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="trophy" className="text-yellow-400"></i> ÊéíË°åÊ¶ú / Top 10
                        </h2>

                        <div className="flex-1 overflow-y-auto space-y-2 pr-1 history-scroll">
                            {loading ? (
                                <div className="text-center text-gray-500 py-8">ËºâÂÖ•‰∏≠...</div>
                            ) : scores.length === 0 ? (
                                <div className="text-center text-gray-500 py-8">Êö´ÁÑ°Á¥ÄÈåÑÔºåÂø´‰æÜÊê∂Á¨¨‰∏ÄÔºÅ</div>
                            ) : (
                                scores.map((score, idx) => (
                                    <div key={score.id} className="bg-white/5 border border-white/10 rounded-lg p-3 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm
                                                ${idx === 0 ? 'bg-yellow-500/20 text-yellow-300' : 
                                                  idx === 1 ? 'bg-gray-400/20 text-gray-300' :
                                                  idx === 2 ? 'bg-orange-600/20 text-orange-400' : 'bg-white/5 text-gray-500'}
                                            `}>
                                                {idx + 1}
                                            </div>
                                            <div>
                                                <div className="font-bold text-white text-sm">{score.name}</div>
                                                <div className="text-xs text-gray-400 truncate max-w-[120px]">{score.message}</div>
                                            </div>
                                        </div>
                                        <div className="font-mono text-neon-blue font-bold">
                                            {formatTime(score.time)}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Victory Modal with Submit ---
        const VictoryModal = ({ onRestart, secret, time, user, onShowLeaderboard }) => {
            const [name, setName] = useState('');
            const [message, setMessage] = useState('');
            const [submitting, setSubmitting] = useState(false);
            const [submitted, setSubmitted] = useState(false);

            const handleSubmit = async () => {
                if (!name.trim() || submitting || !user) return;
                setSubmitting(true);
                try {
                    // Compat Syntax
                    const leaderboardRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard');
                    
                    await leaderboardRef.add({
                        name: name.trim(),
                        message: message.trim() || 'No message',
                        time: time,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: user.uid
                    });
                    
                    setSubmitted(true);
                    onShowLeaderboard(); 
                } catch (e) {
                    console.error("Error submitting score: ", e);
                    setSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="glass-panel p-6 rounded-2xl max-w-sm w-full text-center border-t-4 border-yellow-400 overflow-y-auto max-h-[90vh]">
                        <div className="text-5xl mb-2">üèÜ</div>
                        <h2 className="text-2xl font-bold text-white mb-1">Ëß£ÈéñÊàêÂäüÔºÅ</h2>
                        <div className="text-4xl font-mono font-bold text-neon-gold mb-4">{formatTime(time)}</div>
                        
                        <div className="bg-black/40 rounded-lg p-2 mb-4">
                            <div className="text-xs text-gray-400 uppercase tracking-widest">Secret Code</div>
                            <div className="text-2xl font-mono font-bold text-white tracking-[0.5em]">{secret.join('')}</div>
                        </div>

                        {!submitted ? (
                            <div className="space-y-3 mb-6">
                                <p className="text-sm text-gray-300">ÁôªË®òÂêçÁïôÈùíÂè≤ÂêßÔºÅ</p>
                                <input 
                                    type="text" placeholder="Ëº∏ÂÖ•Â§ßÂêç (Name)" 
                                    maxLength="10"
                                    value={name} onChange={e => setName(e.target.value)}
                                    className="w-full bg-black/30 border border-white/20 rounded-lg p-3 text-white focus:border-cyan-500 outline-none transition-colors"
                                />
                                <input 
                                    type="text" placeholder="Áïô‰∏ã‰∏ÄÂè•Ë©± (Message)" 
                                    maxLength="20"
                                    value={message} onChange={e => setMessage(e.target.value)}
                                    className="w-full bg-black/30 border border-white/20 rounded-lg p-3 text-white focus:border-cyan-500 outline-none transition-colors"
                                />
                                <button 
                                    onClick={handleSubmit}
                                    disabled={!name.trim() || submitting}
                                    className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all
                                        ${!name.trim() ? 'bg-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-cyan-600 to-blue-600 hover:scale-105'}
                                    `}
                                >
                                    {submitting ? 'ÂÇ≥ÈÄÅ‰∏≠...' : 'ÈÄÅÂá∫ÊàêÁ∏æ / Submit'}
                                </button>
                            </div>
                        ) : (
                            <div className="mb-6 text-green-400 font-bold bg-green-900/20 p-3 rounded-lg border border-green-500/30">
                                ÊàêÁ∏æÂ∑≤‰∏äÂÇ≥ÔºÅ
                            </div>
                        )}

                        <div className="flex gap-2">
                            <button 
                                onClick={onRestart}
                                className="flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl text-white font-bold transition-colors"
                            >
                                ÂÜçÁé©‰∏ÄÊ¨°
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const RulesModal = ({ onClose }) => (
             <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in">
                <div className="glass-panel p-6 rounded-2xl max-w-sm w-full relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                        <i data-lucide="x" className="w-6 h-6"></i>
                    </button>
                    <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="brain-circuit" className="text-cyan-400"></i> ÈÅäÊà≤Ë¶èÂâá / Rules
                    </h2>
                    <ul className="space-y-4 text-gray-300 text-sm leading-relaxed">
                        <li className="flex gap-3"><span className="bg-cyan-500/20 text-cyan-300 w-6 h-6 flex items-center justify-center rounded-full text-xs shrink-0 mt-0.5">1</span><div><div className="mb-1 font-medium text-white">ÁõÆÊ®ôÔºöÁåúÂá∫ÈõªËÖ¶Ë®≠ÂÆöÁöÑ 4 ÂÄã<strong>‰∏çÈáçË§á</strong>Êï∏Â≠ó„ÄÇ</div><div className="text-xs text-gray-500">Goal: Guess 4 <strong>unique</strong> numbers generated by the system.</div></div></li>
                        <li className="flex gap-3"><span className="bg-yellow-500/20 text-yellow-300 w-6 h-6 flex items-center justify-center rounded-full text-xs shrink-0 mt-0.5">A</span><div><div className="mb-1 font-medium text-white"><strong>Êï∏Â≠óÂ∞çÔºå‰ΩçÁΩÆ‰πüÂ∞ç</strong>„ÄÇ<br/><span className="text-gray-400 text-xs">‰æãÔºöË¨éÂ∫ï 1234ÔºåÁåú 1000 ‚Üí 1A</span></div><div className="text-xs text-gray-500"><strong>Correct number & position</strong>.</div></div></li>
                        <li className="flex gap-3"><span className="bg-blue-500/20 text-blue-300 w-6 h-6 flex items-center justify-center rounded-full text-xs shrink-0 mt-0.5">B</span><div><div className="mb-1 font-medium text-white"><strong>Êï∏Â≠óÂ∞çÔºå‰ΩÜ‰ΩçÁΩÆÈåØ</strong>„ÄÇ<br/><span className="text-gray-400 text-xs">‰æãÔºöË¨éÂ∫ï 1234ÔºåÁåú 0100 ‚Üí 1B</span></div><div className="text-xs text-gray-500"><strong>Correct number, wrong position</strong>.</div></div></li>
                        <li className="flex gap-3"><span className="bg-green-500/20 text-green-300 w-6 h-6 flex items-center justify-center rounded-full text-xs shrink-0 mt-0.5">4</span><div><div className="mb-1 font-medium text-white">Áç≤Âæó <strong>4A0B</strong> Âç≥ÁÇ∫ÂãùÂà©ÔºÅ</div><div className="text-xs text-gray-500">Get <strong>4A0B</strong> to win!</div></div></li>
                    </ul>
                    <button onClick={onClose} className="mt-6 w-full py-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-xl text-white font-semibold transition-colors">ÈñãÂßãËß£Á¢º / Start</button>
                </div>
            </div>
        );

        const AnswerModal = ({ onClose, secret }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in">
                <div className="glass-panel p-6 rounded-2xl max-w-sm w-full relative text-center border-t-4 border-red-500">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" className="w-6 h-6"></i></button>
                    <div className="text-5xl mb-4">üîì</div>
                    <h2 className="text-2xl font-bold text-white mb-2">Ê©üÂØÜÊè≠Êõâ</h2>
                    <p className="text-gray-400 text-sm mb-6">ÈÇèËºØÊ†∏ÂøÉÊï∏ÊìöÂº∑Âà∂ËÆÄÂèñ‰∏≠...</p>
                    <div className="bg-black/40 rounded-lg p-4 mb-6 border border-red-500/30">
                        <div className="text-xs text-red-400 uppercase tracking-widest mb-1">SYSTEM SECRET</div>
                        <div className="text-4xl font-mono font-bold text-red-500 tracking-[0.5em] pl-2 drop-shadow-[0_0_10px_rgba(239,68,68,0.5)]">{secret.join('')}</div>
                    </div>
                    <button onClick={onClose} className="w-full py-3 bg-white/10 hover:bg-red-500/20 border border-white/20 hover:border-red-500/50 rounded-xl text-white font-semibold transition-all">ÈóúÈñâË¶ñÁ™ó</button>
                </div>
            </div>
        );

        const App = () => {
            // Fixed: Destructure setGameState from hook
            const { secret, history, gameState, setGameState, startNewGame, submitGuess, showRules, setShowRules, timer } = useGameLogic();
            const [currentInput, setCurrentInput] = useState([]);
            const [showAnswer, setShowAnswer] = useState(false);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [user, setUser] = useState(null);

            // Auth Init (Compat)
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);
            
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const handleInput = (num) => {
                if (currentInput.length < 4 && !currentInput.includes(num)) setCurrentInput([...currentInput, num]);
            };

            const handleDelete = () => setCurrentInput(currentInput.slice(0, -1));

            const handleSubmit = () => {
                if (currentInput.length === 4) {
                    submitGuess(currentInput);
                    setCurrentInput([]);
                }
            };

            const renderSlots = () => (
                <div className="flex justify-center gap-3 mb-6">
                    {[0, 1, 2, 3].map(idx => (
                        <div key={idx} className={`w-14 h-16 rounded-xl border-2 flex items-center justify-center text-3xl font-bold transition-all duration-300
                            ${currentInput[idx] !== undefined ? 'bg-cyan-900/40 border-cyan-400 text-white shadow-[0_0_15px_rgba(0,243,255,0.3)] transform scale-105' : 'bg-black/30 border-white/10 text-gray-500'}
                        `}>
                            {currentInput[idx] !== undefined ? currentInput[idx] : ''}
                        </div>
                    ))}
                </div>
            );

            return (
                <div id="ui-layer" className="font-sans text-white">
                    <ThreeBackground gameState={gameState} />

                    {/* Header */}
                    <header className="px-6 py-4 flex justify-between items-center glass-panel border-x-0 border-t-0 z-20">
                        <div className="flex flex-col">
                            <h1 className="text-xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">1A2B</h1>
                            <div className="flex items-center gap-2">
                                <i data-lucide="clock" className="w-4 h-4 text-cyan-500"></i>
                                <span className="font-mono text-xl font-bold text-neon-blue">{formatTime(timer)}</span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowLeaderboard(true)} className="p-2 rounded-full hover:bg-white/10 transition-colors" title="ÊéíË°åÊ¶ú">
                                <i data-lucide="trophy" className="w-6 h-6 text-yellow-400"></i>
                            </button>
                            <button onClick={() => setShowAnswer(true)} className="p-2 rounded-full hover:bg-white/10 transition-colors" title="ÂÖ¨Â∏ÉÁ≠îÊ°à">
                                <i data-lucide="eye" className="w-6 h-6 text-red-400"></i>
                            </button>
                             <button onClick={() => setShowRules(true)} className="p-2 rounded-full hover:bg-white/10 transition-colors" title="Ë¶èÂâá">
                                <i data-lucide="help-circle" className="w-6 h-6 text-cyan-300"></i>
                            </button>
                            <button onClick={startNewGame} className="p-2 rounded-full hover:bg-white/10 transition-colors" title="ÈáçÊñ∞ÈñãÂßã">
                                <i data-lucide="rotate-ccw" className="w-6 h-6 text-cyan-300"></i>
                            </button>
                        </div>
                    </header>

                    {/* Main Game Area */}
                    <main className="flex-1 flex flex-col max-w-md w-full mx-auto relative overflow-hidden">
                        <div className="flex-1 overflow-y-auto p-4 history-scroll space-y-reverse flex flex-col-reverse">
                            <div className="space-y-2 pb-2">
                                {history.length === 0 && (
                                    <div className="text-center text-gray-500 mt-10 opacity-60">
                                        <i data-lucide="terminal" className="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                        <p>Ë®àÊôÇÂ∑≤ÈñãÂßã...</p>
                                    </div>
                                )}
                                {history.map((entry, idx) => (
                                    <GuessRow key={idx} guess={entry.guess} a={entry.a} b={entry.b} isLatest={idx === 0} />
                                ))}
                            </div>
                        </div>
                        <div className="glass-panel border-x-0 border-b-0 rounded-t-3xl pb-safe-area pt-6 z-30 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                            {renderSlots()}
                            <Keypad onInput={handleInput} onDelete={handleDelete} onSubmit={handleSubmit} currentInput={currentInput} disabled={gameState === 'won'} />
                        </div>
                    </main>

                    {gameState === 'won' && (
                        <VictoryModal 
                            onRestart={startNewGame} 
                            secret={secret} 
                            time={timer}
                            user={user}
                            onShowLeaderboard={() => {
                                setGameState('playing'); // Close victory modal implicitly (or keep background)
                                setShowLeaderboard(true);
                            }}
                        />
                    )}
                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}
                    {showAnswer && <AnswerModal onClose={() => setShowAnswer(false)} secret={secret} />}
                    {showLeaderboard && <LeaderboardModal onClose={() => setShowLeaderboard(false)} user={user} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
