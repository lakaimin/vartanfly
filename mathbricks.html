<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MathBricks - 樂高數學積木</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel 用來解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 自定義樣式 -->
    <style>
        body {
            touch-action: manipulation; /* 優化觸控操作 */
            -webkit-tap-highlight-color: transparent;
        }

        .lego-studs::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(255,255,255,0.25) 20%, transparent 20%);
            background-size: 10px 10px;
            background-position: 5px 5px;
            opacity: 0.5;
            border-radius: inherit;
            pointer-events: none;
        }
        
        .dashed-border {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23CBD5E1' stroke-width='4' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='round'/%3e%3c/svg%3e");
            background-color: transparent;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px) rotate(-5deg); }
            75% { transform: translateX(8px) rotate(5deg); }
        }
        .animate-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icon Components (SVG) ---
        // 為了單一檔案運行，將 lucide-react 改為直接 SVG 繪製
        const IconBase = ({ children, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></IconBase>;
        const Award = (props) => <IconBase {...props}><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 18 12" /></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14" /><path d="M12 5v14" /></IconBase>;
        const Minus = (props) => <IconBase {...props}><path d="M5 12h14" /></IconBase>;
        const Divide = (props) => <IconBase {...props}><circle cx="12" cy="6" r="1" /><line x1="5" x2="19" y1="12" y2="12" /><circle cx="12" cy="18" r="1" /></IconBase>;
        const CloseIcon = (props) => <IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 18 12" /></IconBase>;

        // --- 視覺與動畫常數 ---
        const COLORS = {
            red: 'bg-red-500 border-red-700 text-white',
            blue: 'bg-blue-500 border-blue-700 text-white',
            green: 'bg-green-500 border-green-700 text-white',
            yellow: 'bg-yellow-400 border-yellow-600 text-yellow-900',
            white: 'bg-white border-gray-300 text-gray-800',
            slate: 'bg-slate-800 border-slate-950 text-white'
        };

        const TYPE_COLORS = {
            add: 'blue',
            sub: 'red',
            mul: 'yellow',
            div: 'green'
        };

        // --- 實用函數 ---
        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // --- 組件：樂高風格按鈕 ---
        const LegoButton = ({ color = 'blue', onClick, children, className = '', disabled = false, size = 'md' }) => {
            const baseStyle = "relative font-bold rounded-lg transition-all active:translate-y-1 active:shadow-none select-none flex items-center justify-center";
            const sizeStyles = {
                sm: "px-3 py-2 text-sm shadow-[0_3px_0_rgba(0,0,0,0.2)]",
                md: "px-6 py-3 text-lg shadow-[0_5px_0_rgba(0,0,0,0.2)]",
                lg: "px-8 py-4 text-xl shadow-[0_6px_0_rgba(0,0,0,0.2)]",
                xl: "w-full py-6 text-2xl shadow-[0_8px_0_rgba(0,0,0,0.2)]"
            };
            
            const colorClass = COLORS[color] || COLORS.blue;
            
            return (
                <button 
                onClick={!disabled ? onClick : undefined} 
                className={`
                    ${baseStyle} 
                    ${sizeStyles[size]} 
                    ${colorClass} 
                    ${disabled ? 'opacity-50 cursor-not-allowed translate-y-1 shadow-none' : 'hover:brightness-110'}
                    ${className}
                    lego-studs
                `}
                >
                <span className="relative z-10 flex items-center gap-2">{children}</span>
                </button>
            );
        };

        // --- 組件：教學卡片 ---
        const TutorialCard = ({ type, onFinish }) => {
            const content = {
                add: {
                title: "加法積木：拆拆看！",
                subtitle: "遇到很難算的加法，我們可以把數字「拆開」來算喔！",
                example: "28 + 35 = ?",
                steps: [
                    { text: "先把 35 拆成 2 和 33 (為了讓 28 變成 30)", visual: "35 ➔ 2 + 33" },
                    { text: "28 加上 2 變成了 30 (整數最棒！)", visual: "28 + 2 = 30" },
                    { text: "最後把剩下的 33 加上去", visual: "30 + 33 = 63" }
                ],
                color: 'blue',
                icon: <Plus className="w-6 h-6" />
                },
                sub: {
                title: "減法積木：借位魔法",
                subtitle: "如果不夠減，就跟旁邊的十位數借一個積木過來！",
                example: "52 - 18 = ?",
                steps: [
                    { text: "2 減 8 不夠減，把 52 變成 40 + 12", visual: "52 ➔ 40 + 12" },
                    { text: "現在用 12 減 8，剩下 4", visual: "12 - 8 = 4" },
                    { text: "別忘了還有 40 減 10 (18的十位)", visual: "40 - 10 = 30" },
                    { text: "合起來就是 34", visual: "30 + 4 = 34" }
                ],
                color: 'red',
                icon: <Minus className="w-6 h-6" />
                },
                mul: {
                title: "乘法積木：拆開算",
                subtitle: "數字太大別害怕，把它拆成兩塊來乘！",
                example: "12 × 4 = ?",
                steps: [
                    { text: "把 12 拆成 10 和 2", visual: "12 ➔ 10 + 2" },
                    { text: "先算 10 乘以 4", visual: "10 × 4 = 40" },
                    { text: "再算 2 乘以 4", visual: "2 × 4 = 8" },
                    { text: "最後加起來！", visual: "40 + 8 = 48" }
                ],
                color: 'yellow',
                icon: <X className="w-6 h-6" />
                },
                div: {
                title: "除法積木：分糖果",
                subtitle: "想成反過來的乘法會更簡單喔！",
                example: "45 ÷ 9 = ?",
                steps: [
                    { text: "想一想：9 乘以多少會是 45？", visual: "9 × ? = 45" },
                    { text: "背九九乘法表：9x1=9... 9x5=45！", visual: "9 × 5 = 45" },
                    { text: "所以答案就是 5", visual: "45 ÷ 9 = 5" }
                ],
                color: 'green',
                icon: <Divide className="w-6 h-6" />
                }
            };

            const current = content[type];

            return (
                <div className="flex flex-col h-full bg-white rounded-2xl p-6 shadow-xl animate-fade-in max-w-md mx-auto">
                <div className={`flex items-center gap-3 mb-6 p-4 rounded-xl ${COLORS[current.color]}`}>
                    {current.icon}
                    <div>
                    <h2 className="text-xl font-bold">{current.title}</h2>
                    <p className="text-sm opacity-90">{current.subtitle}</p>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                    <div className="text-center text-3xl font-black text-slate-700 mb-6 bg-slate-100 py-4 rounded-lg shadow-inner">
                    {current.example}
                    </div>
                    
                    {current.steps.map((step, idx) => (
                    <div key={idx} className="flex gap-4 items-start">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white shrink-0 ${COLORS[current.color]}`}>
                        {idx + 1}
                        </div>
                        <div className="bg-gray-50 p-3 rounded-lg w-full border border-gray-100">
                        <p className="text-gray-700 font-medium mb-1">{step.text}</p>
                        <p className="text-lg font-bold text-slate-600 font-mono bg-white inline-block px-2 py-1 rounded border border-gray-200">{step.visual}</p>
                        </div>
                    </div>
                    ))}
                </div>

                <div className="mt-6 pt-4 border-t border-gray-100">
                    <LegoButton color={current.color} size="xl" onClick={onFinish}>
                    我懂了，開始挑戰！ <ArrowRight />
                    </LegoButton>
                </div>
                </div>
            );
        };

        // --- 組件：遊戲主畫面 ---
        const GamePlay = ({ type, onGameOver }) => {
            const [problem, setProblem] = useState(null);
            const [options, setOptions] = useState([]);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [gameState, setGameState] = useState('playing'); // playing, correct, wrong
            const [streak, setStreak] = useState(0);

            // 生成題目邏輯
            const generateProblem = () => {
                let n1, n2, ans, symbol;
                
                switch(type) {
                case 'add':
                    n1 = randomInt(15, 80);
                    n2 = randomInt(10, 99 - n1); 
                    ans = n1 + n2;
                    symbol = '+';
                    break;
                case 'sub':
                    n1 = randomInt(25, 99);
                    n2 = randomInt(10, n1 - 10);
                    ans = n1 - n2;
                    symbol = '-';
                    break;
                case 'mul':
                    n1 = randomInt(10, 20); 
                    n2 = randomInt(2, 9);
                    ans = n1 * n2;
                    symbol = '×';
                    break;
                case 'div':
                    n2 = randomInt(2, 9);
                    ans = randomInt(10, 20); 
                    n1 = n2 * ans;
                    symbol = '÷';
                    break;
                default:
                    return;
                }

                // 生成選項
                let opts = new Set([ans]);
                while(opts.size < 4) {
                    let offset = randomInt(-10, 10);
                    let fake = ans + offset;
                    if (fake > 0 && fake !== ans) opts.add(fake);
                }

                setProblem({ n1, n2, ans, symbol });
                setOptions(Array.from(opts).sort(() => Math.random() - 0.5));
                setGameState('playing');
            };

            useEffect(() => {
                generateProblem();
            }, [type]);

            // 計時器
            useEffect(() => {
                if (timeLeft <= 0) {
                onGameOver(score);
                return;
                }
                const timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                return () => clearInterval(timer);
            }, [timeLeft]);

            const handleAnswer = (val) => {
                if (gameState !== 'playing') return;

                if (val === problem.ans) {
                setGameState('correct');
                setScore(s => s + 10 + (streak * 2)); 
                setStreak(s => s + 1);
                setTimeout(generateProblem, 800);
                } else {
                setGameState('wrong');
                setStreak(0);
                setTimeout(() => {
                    setGameState('playing');
                }, 500);
                }
            };

            if (!problem) return <div className="p-10 text-center">Loading...</div>;

            return (
                <div className="flex flex-col h-full max-w-md mx-auto">
                <div className="flex justify-between items-center bg-slate-800 rounded-b-xl px-6 py-4 text-white shadow-lg mb-6">
                    <div className="flex items-center gap-2">
                    <Star className={`w-5 h-5 ${streak > 1 ? 'fill-yellow-400 text-yellow-400 animate-pulse' : 'text-gray-400'}`} />
                    <span className="font-bold text-xl">{score}</span>
                    </div>
                    <div className="bg-slate-700 px-3 py-1 rounded-full text-sm font-mono">
                    {Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}
                    </div>
                </div>

                <div className="flex-1 flex flex-col justify-center items-center mb-8 relative">
                    <div className={`transition-all duration-300 transform ${gameState === 'correct' ? 'scale-110' : ''} ${gameState === 'wrong' ? 'animate-shake' : ''}`}>
                    <div className="flex justify-center mb-2">
                        <div className={`w-24 h-20 flex items-center justify-center text-4xl font-black bg-white rounded-lg border-b-4 border-r-4 border-gray-300 shadow-md`}>
                        {problem.n1}
                        </div>
                    </div>
                    
                    <div className="flex items-center gap-4">
                        <div className="w-12 h-12 flex items-center justify-center bg-gray-200 rounded-full text-2xl font-bold text-slate-600 shadow-inner">
                        {problem.symbol}
                        </div>
                        <div className={`w-24 h-20 flex items-center justify-center text-4xl font-black bg-white rounded-lg border-b-4 border-r-4 border-gray-300 shadow-md`}>
                        {problem.n2}
                        </div>
                    </div>
                    
                    <div className="w-48 h-2 bg-slate-800 rounded-full mt-6 mb-6 opacity-20 mx-auto"></div>

                    <div className="flex justify-center">
                        <div className={`w-28 h-24 flex items-center justify-center text-5xl font-black rounded-xl border-b-8 border-r-8 transition-colors
                        ${gameState === 'correct' ? 'bg-green-400 border-green-600 text-white' : 
                            gameState === 'wrong' ? 'bg-red-400 border-red-600 text-white' : 
                            'bg-slate-100 border-slate-300 text-slate-400 dashed-border'}
                        `}>
                        {gameState === 'correct' ? problem.ans : '?'}
                        </div>
                    </div>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4 pb-6">
                    {options.map((opt, idx) => (
                    <LegoButton 
                        key={idx} 
                        color={TYPE_COLORS[type]} 
                        size="lg"
                        onClick={() => handleAnswer(opt)}
                        className="text-2xl font-mono"
                        disabled={gameState !== 'playing'}
                    >
                        {opt}
                    </LegoButton>
                    ))}
                </div>
                </div>
            );
        };

        // --- 組件：主程式 ---
        const App = () => {
            const [screen, setScreen] = useState('menu'); 
            const [selectedType, setSelectedType] = useState('add');
            const [finalScore, setFinalScore] = useState(0);

            const startGame = (type) => {
                setSelectedType(type);
                setScreen('tutorial');
            };

            const finishTutorial = () => {
                setScreen('game');
            };

            const handleGameOver = (score) => {
                setFinalScore(score);
                setScreen('result');
            };

            const resetGame = () => {
                setScreen('menu');
                setFinalScore(0);
            };

            return (
                <div className="min-h-screen bg-slate-100 font-sans selection:bg-blue-200 overflow-hidden relative">
                <div className="absolute inset-0 opacity-5 pointer-events-none" 
                    style={{
                        backgroundImage: 'radial-gradient(#000 20%, transparent 20%)',
                        backgroundSize: '40px 40px'
                    }}>
                </div>

                <div className="relative z-10 h-screen flex flex-col p-4 md:p-6 max-w-2xl mx-auto">
                    
                    <header className="flex justify-between items-center py-2 mb-2">
                    <div className="flex items-center gap-2">
                        <div className="w-10 h-10 bg-red-500 rounded flex items-center justify-center shadow-[0_4px_0_rgba(185,28,28,1)]">
                        <span className="text-white font-black text-xl">M</span>
                        </div>
                        <h1 className="text-2xl md:text-3xl font-black text-slate-800 tracking-tight">MathBricks</h1>
                    </div>
                    {screen !== 'menu' && (
                        <button onClick={resetGame} className="p-2 bg-white rounded-full shadow hover:bg-gray-50 text-slate-500">
                        <CloseIcon size={20} />
                        </button>
                    )}
                    </header>

                    <main className="flex-1 relative">
                    
                    {screen === 'menu' && (
                        <div className="h-full flex flex-col justify-center animate-fade-in">
                        <div className="text-center mb-8">
                            <h2 className="text-3xl font-bold text-slate-700 mb-2">準備好挑戰了嗎？</h2>
                            <p className="text-slate-500">選擇一種積木魔法來練習！</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <LegoButton color="blue" size="xl" onClick={() => startGame('add')}>
                            <Plus className="w-8 h-8" /> 加法大師
                            </LegoButton>
                            <LegoButton color="red" size="xl" onClick={() => startGame('sub')}>
                            <Minus className="w-8 h-8" /> 減法偵探
                            </LegoButton>
                            <LegoButton color="yellow" size="xl" onClick={() => startGame('mul')}>
                            <X className="w-8 h-8" /> 乘法超人
                            </LegoButton>
                            <LegoButton color="green" size="xl" onClick={() => startGame('div')}>
                            <Divide className="w-8 h-8" /> 除法博士
                            </LegoButton>
                        </div>

                        <div className="mt-8 text-center">
                            <div className="inline-block bg-white px-4 py-2 rounded-lg shadow-sm text-sm text-slate-400">
                            適合 7-12 歲小學生 • 兩位數四則運算
                            </div>
                        </div>
                        </div>
                    )}

                    {screen === 'tutorial' && (
                        <TutorialCard type={selectedType} onFinish={finishTutorial} />
                    )}

                    {screen === 'game' && (
                        <GamePlay type={selectedType} onGameOver={handleGameOver} />
                    )}

                    {screen === 'result' && (
                        <div className="h-full flex flex-col justify-center items-center text-center animate-pop-in">
                        <div className="mb-6 relative">
                            <Award className="w-32 h-32 text-yellow-400 drop-shadow-lg mx-auto" />
                            <div className="absolute -top-2 -right-2 bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold animate-bounce shadow-md">!</div>
                        </div>
                        
                        <h2 className="text-4xl font-black text-slate-800 mb-2">時間到！</h2>
                        <p className="text-slate-500 mb-8 text-lg">你這次蓋出了好高的分數</p>
                        
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm mb-8 border-b-8 border-slate-200">
                            <span className="text-sm text-slate-400 font-bold uppercase tracking-wider">Total Score</span>
                            <div className="text-6xl font-black text-blue-500 mt-2 mb-2">{finalScore}</div>
                            <div className="flex justify-center gap-1">
                            {[...Array(Math.min(5, Math.ceil(finalScore / 50)))].map((_, i) => (
                                <Star key={i} className="w-6 h-6 fill-yellow-400 text-yellow-400" />
                            ))}
                            </div>
                        </div>

                        <div className="flex gap-4 w-full max-w-sm">
                            <LegoButton color="white" size="lg" className="flex-1" onClick={() => setScreen('menu')}>
                            選別的
                            </LegoButton>
                            <LegoButton color="blue" size="lg" className="flex-1" onClick={() => setScreen('game')}>
                            <RotateCcw className="w-5 h-5" /> 再玩一次
                            </LegoButton>
                        </div>
                        </div>
                    )}

                    </main>

                    <footer className="mt-2 text-center text-slate-400 text-sm font-medium py-2">
                    Designed by <a href="https://vartanliu.blogspot.com/" target="_blank" rel="noopener noreferrer" className="text-slate-500 hover:text-blue-600 hover:underline transition-colors">Vartan Liu</a>
                    </footer>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>