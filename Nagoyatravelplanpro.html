<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>名古屋親子慢活遊 | 2026</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F2F2F7;
            color: #1D1D1F;
            -webkit-tap-highlight-color: transparent;
        }
        .mono-font { font-family: 'Roboto Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .card-base {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .card-base:active { transform: scale(0.98); }
        
        .timeline-line {
            position: absolute;
            left: 23px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: #E5E5EA;
            z-index: 0;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="antialiased pb-28">

<div id="app" class="max-w-md mx-auto min-h-screen bg-[#F2F2F7] relative sm:border-x sm:border-gray-300">

    <!-- Header 區域 -->
    <header class="bg-white px-6 pt-12 pb-8 rounded-b-[2.5rem] shadow-sm mb-6 z-20 relative">
        <div class="flex justify-between items-start mb-6">
            <div class="w-full">
                <!-- 動態天數顯示 -->
                <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-gray-100 text-[10px] font-bold tracking-wider text-gray-500 mb-2">
                    <i class="fa-solid fa-plane-departure"></i> {{ itinerary.length }} DAYS TRIP
                </div>
                
                <!-- 可編輯標題區域 -->
                <div class="relative group/title">
                    <!-- 顯示模式 -->
                    <h1 v-if="!isEditingTitle" 
                        class="text-3xl font-bold tracking-tight text-gray-900 leading-tight whitespace-pre-line cursor-pointer hover:opacity-70 transition"
                        @click="startEditTitle">
                        {{ tripTitle }}
                        <span class="inline-block align-top ml-2 opacity-0 group-hover/title:opacity-100 transition-opacity">
                            <i class="fa-solid fa-pen text-sm text-gray-300"></i>
                        </span>
                    </h1>
                    
                    <!-- 編輯模式 -->
                    <div v-else class="flex flex-col gap-2">
                        <textarea ref="titleInput" 
                                  v-model="tempTitle" 
                                  rows="2" 
                                  class="w-full text-3xl font-bold tracking-tight text-gray-900 leading-tight bg-gray-50 border border-blue-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                        <div class="flex gap-2">
                            <button @click="saveTitle" class="bg-black text-white px-3 py-1 rounded-md text-xs font-bold">儲存</button>
                            <button @click="cancelEditTitle" class="bg-gray-200 text-gray-600 px-3 py-1 rounded-md text-xs font-bold">取消</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-2 text-xs text-gray-400 font-medium flex items-center gap-1">
                    <span>Designed by</span>
                    <a href="https://vartanliu.blogspot.com/" target="_blank" class="text-gray-500 hover:text-black transition-colors decoration-none border-b border-gray-300 pb-0.5">Vartan Liu</a>
                </div>

            </div>
            
            <!-- 設定按鈕 -->
            <button @click="showSettings = true" class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-gray-800 transition ml-2">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>

        <!-- 預算卡片 -->
        <div class="bg-[#1C1C1E] text-white p-5 rounded-2xl shadow-xl relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full blur-3xl opacity-30 -mr-10 -mt-10"></div>
            
            <div class="relative z-10 flex flex-col justify-between h-full">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-medium text-gray-400 uppercase tracking-widest">剩餘預算</span>
                            <span class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 mono-font">JPY</span>
                        </div>
                        <span class="text-3xl font-bold mono-font tracking-tighter block">¥{{ remainingBudget.toLocaleString() }}</span>
                    </div>

                    <div class="text-right">
                        <div class="text-[10px] text-gray-500 mb-1">總預算設定</div>
                        <div v-if="!isEditingBudget" 
                             @click="startEditBudget"
                             class="flex items-center justify-end gap-2 bg-gray-800/40 pl-3 pr-2 py-1.5 rounded-lg backdrop-blur-sm cursor-pointer hover:bg-gray-700 transition group border border-transparent hover:border-gray-600">
                            <span class="text-sm font-bold text-gray-300 mono-font">¥{{ totalBudget.toLocaleString() }}</span>
                            <i class="fa-solid fa-pen text-[10px] text-gray-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <div v-else class="flex items-center justify-end gap-1">
                            <input ref="budgetInput" 
                                   v-model.number="tempBudget" 
                                   @blur="saveBudget" 
                                   @keyup.enter="saveBudget"
                                   type="number" 
                                   class="w-24 bg-gray-700 text-white text-sm px-2 py-1.5 rounded-lg border border-blue-500 focus:outline-none mono-font text-right"
                                   placeholder="輸入金額">
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1.5">
                        <span>預算使用率</span>
                        <span :class="{'text-red-400': budgetProgress > 90, 'text-blue-400': budgetProgress <= 90}">
                            {{ budgetProgress.toFixed(0) }}%
                        </span>
                    </div>
                    <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-700 ease-out" 
                             :class="budgetProgress > 100 ? 'bg-red-500' : 'bg-gradient-to-r from-blue-400 to-purple-400'"
                             :style="{ width: Math.min(budgetProgress, 100) + '%' }"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 重點資訊摘要 -->
        <div class="flex gap-3 mt-6 overflow-x-auto no-scrollbar pb-1">
            <div class="flex-shrink-0 bg-gray-50 px-4 py-3 rounded-xl border border-gray-100">
                <div class="text-xs text-gray-400 mb-1">住宿</div>
                <div class="font-bold text-sm text-gray-800">Ibis Styles Nagoya</div>
            </div>
            <div class="flex-shrink-0 bg-gray-50 px-4 py-3 rounded-xl border border-gray-100">
                <div class="text-xs text-gray-400 mb-1">去程航班</div>
                <div class="font-bold text-sm text-gray-800">CX530 11:55</div>
            </div>
            <div class="flex-shrink-0 bg-gray-50 px-4 py-3 rounded-xl border border-gray-100">
                <div class="text-xs text-gray-400 mb-1">回程航班</div>
                <div class="font-bold text-sm text-gray-800">CX531 16:50</div>
            </div>
        </div>
    </header>

    <!-- 主要內容區 -->
    <main class="px-5">
        
        <!-- Tab 1: 行程時間軸 -->
        <div v-if="currentTab === 'timeline'" class="pb-8">
            <div v-for="(day, dayIndex) in itinerary" :key="dayIndex" class="mb-10 relative animate-fade-in">
                
                <div class="sticky top-2 z-10 flex justify-center mb-6">
                    <div class="bg-white/90 backdrop-blur-md shadow-sm border border-gray-100 px-4 py-1.5 rounded-full flex items-center gap-2">
                        <span class="bg-black text-white text-[10px] font-bold px-2 py-0.5 rounded-full">Day {{ dayIndex + 1 }}</span>
                        <span class="text-sm font-bold text-gray-800">{{ day.date }}</span>
                        <span class="text-xs text-gray-500 pl-1 border-l border-gray-300">{{ day.weather }}</span>
                    </div>
                </div>

                <div class="relative pl-2">
                    <div class="timeline-line"></div>

                    <div v-for="(item, i) in day.activities" :key="i" class="relative pl-10 mb-8 last:mb-0 group">
                        <div class="absolute left-[14px] top-5 w-4 h-4 rounded-full border-[3px] border-white shadow-sm z-10" 
                             :class="getDotColor(item.type)"></div>
                        
                        <!-- 正常顯示模式 (View Mode) -->
                        <div v-if="!isEditing(dayIndex, i)" class="card-base p-5 relative overflow-hidden group/card">
                            <div class="absolute top-3 right-3 flex gap-2 transition opacity-100 sm:opacity-0 sm:group-hover/card:opacity-100 z-20">
                                <button @click="startEditActivity(dayIndex, i)" class="text-gray-400 hover:text-blue-500 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center">
                                    <i class="fa-solid fa-pen text-sm"></i>
                                </button>
                                <button @click="deleteActivity(dayIndex, i)" class="text-gray-400 hover:text-red-500 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center">
                                    <i class="fa-solid fa-trash-can text-sm"></i>
                                </button>
                            </div>

                            <div class="flex justify-between items-start mb-2 pr-16">
                                <span class="mono-font text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-md">{{ item.time }}</span>
                                <div class="flex gap-2">
                                    <span v-if="item.cost" class="text-[10px] font-medium px-2 py-1 rounded bg-yellow-50 text-yellow-700 border border-yellow-100">
                                        票: ¥{{ item.cost }}
                                    </span>
                                </div>
                            </div>

                            <h3 class="text-lg font-bold text-gray-800 mb-1">{{ item.title }}</h3>
                            <p class="text-sm text-gray-500 leading-relaxed mb-3">{{ item.desc }}</p>

                            <div class="flex flex-wrap gap-2 mb-3" v-if="item.tags && item.tags.length > 0">
                                <span v-for="tag in item.tags" class="text-[10px] px-2 py-1 rounded bg-gray-100 text-gray-500">
                                    #{{ tag }}
                                </span>
                            </div>

                            <div class="flex items-center justify-between pt-3 border-t border-gray-50 mt-1">
                                <a v-if="item.location" :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.location)" target="_blank" 
                                   class="text-xs font-bold text-blue-500 flex items-center gap-1 hover:opacity-70">
                                    <i class="fa-solid fa-location-arrow"></i> 導航
                                </a>
                                <span v-else></span>
                                
                                <button @click="quickAddExpense(item.title)" class="text-gray-300 hover:text-gray-800 transition">
                                    <i class="fa-solid fa-plus-circle text-lg"></i>
                                </button>
                            </div>
                            
                            <div class="absolute left-0 top-0 bottom-0 w-1" :class="getBarColor(item.type)"></div>
                        </div>

                        <!-- 編輯模式 (Edit Mode) -->
                        <div v-else class="card-base p-4 border-2 border-blue-200 bg-blue-50/30 relative z-20">
                            <h4 class="text-xs font-bold text-blue-500 mb-3">編輯行程</h4>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input v-model="tempEditActivity.time" type="time" class="bg-white border border-gray-200 rounded-lg px-2 py-2 text-xs w-1/3 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <select v-model="tempEditActivity.type" class="bg-white border border-gray-200 rounded-lg px-2 py-2 text-xs w-2/3 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="sight">觀光 (綠色)</option>
                                        <option value="food">美食 (橘色)</option>
                                        <option value="shopping">購物 (粉色)</option>
                                        <option value="transport">交通 (藍色)</option>
                                        <option value="stay">住宿 (紫色)</option>
                                    </select>
                                </div>
                                <input v-model="tempEditActivity.title" type="text" placeholder="標題" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-400 text-xs"><i class="fa-solid fa-location-dot"></i></span>
                                    <input v-model="tempEditActivity.location" type="text" placeholder="導航地點 (Google Maps 關鍵字)" class="w-full bg-white border border-gray-200 rounded-lg pl-8 pr-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                                <textarea v-model="tempEditActivity.desc" rows="2" placeholder="備註描述..." class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none"></textarea>
                                <div class="flex gap-2">
                                     <input v-model.number="tempEditActivity.cost" type="number" placeholder="預估票價" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                                <input v-model="tempEditActivity.tagsString" type="text" placeholder="標籤 (用逗號分隔)" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                                
                                <div class="flex gap-2 pt-2">
                                    <button @click="cancelEditActivity" class="flex-1 bg-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold">取消</button>
                                    <button @click="saveEditActivity" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold shadow-md">儲存修改</button>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- 新增行程按鈕/表單 -->
                    <div class="pl-10 mt-6 relative">
                         <div class="absolute left-[18px] top-6 w-2 h-2 rounded-full bg-gray-300 z-10"></div>

                        <div v-if="addingDayIndex === dayIndex" class="card-base p-4 border-2 border-dashed border-gray-300 bg-gray-50/50">
                            <h4 class="text-xs font-bold text-gray-400 mb-3">新增行程</h4>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input v-model="newActivity.time" type="time" class="bg-white border border-gray-200 rounded-lg px-2 py-2 text-xs w-1/3 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <select v-model="newActivity.type" class="bg-white border border-gray-200 rounded-lg px-2 py-2 text-xs w-2/3 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="sight">觀光 (綠色)</option>
                                        <option value="food">美食 (橘色)</option>
                                        <option value="shopping">購物 (粉色)</option>
                                        <option value="transport">交通 (藍色)</option>
                                        <option value="stay">住宿 (紫色)</option>
                                    </select>
                                </div>
                                <input v-model="newActivity.title" type="text" placeholder="標題 (例如: 名古屋城)" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-400 text-xs"><i class="fa-solid fa-location-dot"></i></span>
                                    <input v-model="newActivity.location" type="text" placeholder="導航地點 (Google Maps 關鍵字)" class="w-full bg-white border border-gray-200 rounded-lg pl-8 pr-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                                <input v-model="newActivity.desc" type="text" placeholder="備註描述..." class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="flex gap-2">
                                     <input v-model.number="newActivity.cost" type="number" placeholder="預估票價 (可選)" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                                </div>
                                
                                <div class="flex gap-2 pt-2">
                                    <button @click="cancelAddActivity" class="flex-1 bg-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold">取消</button>
                                    <button @click="saveNewActivity(dayIndex)" class="flex-1 bg-black text-white py-2 rounded-lg text-xs font-bold">儲存</button>
                                </div>
                            </div>
                        </div>

                        <button v-else @click="startAddActivity(dayIndex)" class="w-full py-3 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 text-sm font-bold hover:border-gray-400 hover:text-gray-600 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> 新增行程
                        </button>
                    </div>

                </div>
            </div>
            
            <div class="bg-slate-800 text-slate-200 p-6 rounded-2xl mt-8 mx-1 mb-20">
                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-lightbulb text-yellow-400"></i> 在地導遊小叮嚀
                </h3>
                <ul class="space-y-3 text-sm opacity-90">
                    <li class="flex gap-2"><i class="fa-solid fa-check mt-1 text-green-400"></i> 市區1-8度，山上負度，務必洋蔥式穿搭。</li>
                    <li class="flex gap-2"><i class="fa-solid fa-check mt-1 text-green-400"></i> 日本冬天乾燥，隨身帶護唇膏/乳液。</li>
                    <li class="flex gap-2"><i class="fa-solid fa-check mt-1 text-green-400"></i> 建議買 eSIM 卡，查地圖最方便。</li>
                    <li class="flex gap-2"><i class="fa-solid fa-check mt-1 text-green-400"></i> 餐廳看 Tabelog 3.5分以上就是神店。</li>
                </ul>
            </div>
        </div>

        <div v-if="currentTab === 'checklist'" class="space-y-6 animate-fade-in pb-20">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                <div class="relative w-32 h-32 mx-auto mb-4 flex items-center justify-center">
                    <svg class="transform -rotate-90 w-32 h-32">
                        <circle cx="64" cy="64" r="60" stroke="#F3F4F6" stroke-width="8" fill="transparent" />
                        <circle cx="64" cy="64" r="60" stroke="#34C759" stroke-width="8" fill="transparent" 
                                :stroke-dasharray="377" :stroke-dashoffset="377 - (377 * checkListProgress) / 100" 
                                class="transition-all duration-1000 ease-out" />
                    </svg>
                    <span class="absolute text-2xl font-bold text-gray-800">{{ checkListProgress }}%</span>
                </div>
                <h3 class="font-bold text-gray-800">準備進度</h3>
                <p class="text-xs text-gray-400 mt-1">出發前請確認所有項目</p>
            </div>

            <div v-for="(category, cIndex) in packingList" :key="cIndex">
                <div class="flex justify-between items-center mb-3 ml-2 pr-2">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">{{ category.name }}</h4>
                    <button @click="deleteCategory(cIndex)" class="text-gray-300 hover:text-red-500 transition text-[10px]">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100">
                    <div v-for="(item, iIndex) in category.items" :key="iIndex" 
                         @click="toggleCheck(cIndex, iIndex)"
                         class="p-4 border-b border-gray-50 last:border-0 flex items-center justify-between cursor-pointer active:bg-gray-50 transition group">
                        
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-6 h-6 rounded-full border-2 flex-shrink-0 flex items-center justify-center transition-all duration-300"
                                 :class="item.checked ? 'bg-green-500 border-green-500 scale-110' : 'border-gray-200'">
                                <i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i>
                            </div>
                            <span :class="item.checked ? 'text-gray-400 line-through' : 'text-gray-800 font-medium'" class="transition-colors break-all pr-2">
                                {{ item.name }}
                            </span>
                        </div>

                        <button @click.stop="deleteItem(cIndex, iIndex)" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>

                    <div class="p-3 bg-gray-50 border-t border-gray-100 flex gap-2">
                        <input v-model="category.newItemInput" 
                               @keyup.enter="addItem(cIndex)" 
                               @click.stop
                               type="text" 
                               placeholder="+ 新增項目..." 
                               class="bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm w-full focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all placeholder-gray-400">
                        <button @click.stop="addItem(cIndex)" class="bg-white text-green-600 border border-gray-200 w-10 rounded-lg shadow-sm hover:bg-green-50 transition flex items-center justify-center">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-dashed hover:border-gray-300 transition">
                <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">新增分類</h4>
                <div class="flex gap-2">
                    <input v-model="newCategoryName" 
                           @keyup.enter="addCategory" 
                           type="text" 
                           placeholder="例如：伴手禮清單" 
                           class="bg-gray-50 border-none rounded-lg px-3 py-2 text-sm w-full outline-none focus:ring-2 focus:ring-gray-400">
                    <button @click="addCategory" class="bg-gray-800 text-white px-4 rounded-lg text-xs font-bold hover:bg-black transition whitespace-nowrap">
                        新增
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'wallet'" class="animate-fade-in pb-20">
            <div class="card-base p-5 mb-6 sticky top-4 z-20 border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wide">新增消費</h3>
                <div class="flex flex-col gap-3">
                    <input v-model="newExpense.title" type="text" placeholder="項目 (例: 鰻魚飯)" class="bg-gray-50 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="flex gap-3">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-3 text-gray-400 text-sm">¥</span>
                            <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-full bg-gray-50 rounded-xl p-3 pl-7 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mono-font">
                        </div>
                        <button @click="addExpense" class="bg-black text-white px-6 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition">
                            記帳
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest ml-2 mb-2">消費紀錄</h4>
                <div v-if="expenses.length === 0" class="text-center py-12 opacity-50">
                    <i class="fa-solid fa-receipt text-4xl text-gray-300 mb-3"></i>
                    <p class="text-sm text-gray-400">目前還沒有消費紀錄</p>
                </div>
                
                <div v-for="(record, index) in expenses" :key="index" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-bag-shopping"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">{{ record.title }}</p>
                            <p class="text-[10px] text-gray-400">{{ record.date }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-gray-900 mono-font">- ¥{{ record.amount.toLocaleString() }}</span>
                        <button @click="removeExpense(index)" class="text-gray-300 hover:text-red-500 transition px-2">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Settings Modal -->
    <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showSettings = false">
        <div class="bg-white rounded-2xl p-6 w-4/5 max-w-sm shadow-2xl animate-fade-in">
            <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-sliders"></i> 設定與資料管理
            </h3>
            <div class="space-y-3">
                <button @click="exportData" class="w-full py-3 bg-gray-100 rounded-xl text-sm font-bold text-gray-700 flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                    <i class="fa-solid fa-download"></i> 匯出備份 (JSON)
                </button>
                <button @click="triggerImport" class="w-full py-3 bg-gray-100 rounded-xl text-sm font-bold text-gray-700 flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                    <i class="fa-solid fa-upload"></i> 匯入備份 (JSON)
                </button>
                <hr class="border-gray-100">
                <button @click="resetData" class="w-full py-3 bg-red-50 text-red-500 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-100 transition">
                    <i class="fa-solid fa-rotate-right"></i> 重置所有資料
                </button>
            </div>
            <button @click="showSettings = false" class="mt-4 w-full py-2 text-gray-400 text-xs font-bold hover:text-gray-600">關閉</button>
        </div>
    </div>
    <input type="file" ref="fileInput" class="hidden" accept=".json" @change="importData">

    <nav class="fixed bottom-0 w-full max-w-md glass-nav z-50">
        <div class="flex justify-around items-center h-16 sm:h-20">
            <button @click="currentTab = 'timeline'" class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200" 
                    :class="currentTab === 'timeline' ? 'text-black' : 'text-gray-400 hover:text-gray-600'">
                <div class="text-xl transition-transform duration-200" :class="currentTab === 'timeline' ? '-translate-y-1' : ''">
                    <i class="fa-solid fa-location-dot"></i>
                </div>
                <span class="text-[10px] font-bold tracking-wide">行程</span>
            </button>
            
            <button @click="currentTab = 'checklist'" class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200" 
                    :class="currentTab === 'checklist' ? 'text-black' : 'text-gray-400 hover:text-gray-600'">
                <div class="text-xl transition-transform duration-200" :class="currentTab === 'checklist' ? '-translate-y-1' : ''">
                    <i class="fa-solid fa-list-check"></i>
                </div>
                <span class="text-[10px] font-bold tracking-wide">清單</span>
            </button>
            
            <button @click="currentTab = 'wallet'" class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors duration-200" 
                    :class="currentTab === 'wallet' ? 'text-black' : 'text-gray-400 hover:text-gray-600'">
                <div class="text-xl transition-transform duration-200" :class="currentTab === 'wallet' ? '-translate-y-1' : ''">
                    <i class="fa-solid fa-wallet"></i>
                </div>
                <span class="text-[10px] font-bold tracking-wide">錢包</span>
            </button>
        </div>
    </nav>

</div>

<script>
    const { createApp } = Vue;

    const DEFAULT_ITINERARY = [
        {
            date: "1/13 (二)",
            weather: "1~8°C",
            activities: [
                { time: "11:55", type: "transport", title: "桃園起飛", desc: "CX530 航班，預計 15:35 抵達名古屋中部機場。", tags: ["TPE -> NGO"], location: "Taoyuan International Airport" },
                { time: "16:30", type: "transport", title: "搭乘 μ-SKY", desc: "前往名古屋車站 (對號座)，約28分鐘。", cost: 1290, tags: ["名鐵特急"], location: "Chubu Centrair International Airport" },
                { time: "17:30", type: "stay", title: "飯店 Check-in", desc: "Ibis Styles Nagoya，從名鐵站步行約10-12分鐘。靠近柳橋中央市場。", location: "Ibis Styles Nagoya" },
                { time: "18:30", type: "sight", title: "榮商圈夜景", desc: "必拍：綠洲21「水的宇宙船」、中部電力塔。", cost: 210, tags: ["地鐵東山線"], location: "Oasis 21" },
                { time: "19:30", type: "food", title: "晚餐：鰻魚飯三吃", desc: "あつた蓬莱軒 (松坂屋店) 或 しら河。在地人推薦必吃。", location: "Atsuta Horaiken Matsuzakayaten" },
                { time: "21:30", type: "shopping", title: "MaxValu 超市", desc: "24小時營業，補給零食飲料。", location: "MaxValu Taiko" }
            ]
        },
        {
            date: "1/14 (三)",
            weather: "山上負度",
            activities: [
                { time: "08:30", type: "transport", title: "前往御在所岳", desc: "名鐵巴士中心3樓，搭三重交通巴士直達。", cost: 1500, location: "Meitetsu Bus Center" },
                { time: "10:00", type: "sight", title: "御在所纜車 & 樹冰", desc: "搭纜車賞樹冰，山上有「雪之廣場」可租雪盆給小朋友玩。", location: "Gozaisho Ropeway" },
                { time: "12:00", type: "food", title: "午餐：咖哩烏龍麵", desc: "山頂餐廳 Nature 必吃招牌。", location: "Gozaisho Ropeway" },
                { time: "16:00", type: "sight", title: "大須商店街", desc: "必逛：大須觀音、水曜日的愛麗絲、Komehyo、Seria百元店。", location: "Osu Shopping Street" },
                { time: "18:00", type: "food", title: "晚餐：矢場味噌豬排", desc: "大須本店，鐵板味噌醬超下飯。", location: "Yabaton Yaba Cho Head Office" }
            ]
        },
        {
            date: "1/15 (四)",
            weather: "1~8°C",
            activities: [
                { time: "09:30", type: "transport", title: "前往樂高樂園", desc: "名古屋站搭「青波線」至金城ふ頭站。", cost: 360, location: "Nagoya Station" },
                { time: "10:00", type: "sight", title: "LEGOLAND Japan", desc: "潛水艇、駕駛學校、Miniland。午餐建議園區內 Knight's Table。", location: "LEGOLAND Japan" },
                { time: "17:00", type: "food", title: "晚餐：世界的山將", desc: "必點夢幻手羽先 (胡椒雞翅)。記得幫小孩點不辣的。", location: "Sekai no Yamachan" }
            ]
        },
        {
            date: "1/16 (五)",
            weather: "1~8°C",
            activities: [
                { time: "09:20", type: "transport", title: "前往長島 Outlet", desc: "名鐵巴士中心4樓22號乘車處。", cost: 1400, location: "Meitetsu Bus Center" },
                { time: "10:30", type: "shopping", title: "Jazz Dream Outlet", desc: "日本店鋪最多! Lego Store, Blue Label, Beams。午餐可在長島Kitchen解決。", location: "Mitsui Outlet Park Jazz Dream Nagashima" },
                { time: "17:30", type: "food", title: "晚餐：榮商圈 / CoCo壹番屋", desc: "或回飯店附近柳橋中央市場吃海鮮居酒屋。", location: "Sakae Station" }
            ]
        },
        {
            date: "1/17 (六)",
            weather: "1~8°C",
            activities: [
                { time: "08:30", type: "stay", title: "Check-out", desc: "行李建議寄放名鐵名古屋站置物櫃。", location: "Meitetsu Nagoya Station" },
                { time: "09:30", type: "sight", title: "豐田產業技術紀念館", desc: "小孩必去 Technoland！纖維館、汽車館實演。", cost: 1000, location: "Toyota Commemorative Museum of Industry and Technology" },
                { time: "13:00", type: "food", title: "午餐：AEON Mall", desc: "Nagoya Noritake Garden，旁邊有蔦屋書店超美書牆。", location: "Aeon Mall Nagoya Noritake Garden" },
                { time: "14:50", type: "transport", title: "前往機場", desc: "搭 μ-SKY。入關前必買「蝦餅」伴手禮！", location: "Chubu Centrair International Airport" },
                { time: "16:50", type: "transport", title: "返台", desc: "CX531 飛往 TPE。", tags: ["NGO -> TPE"] }
            ]
        }
    ];

    createApp({
        data() {
            return {
                currentTab: 'timeline',
                tripTitle: "名古屋\n親子慢活旅",
                isEditingTitle: false,
                tempTitle: "",
                showSettings: false, // New: Settings modal state
                
                totalBudget: 150000, 
                tempBudget: 0,
                isEditingBudget: false,
                newExpense: { title: '', amount: '' },
                
                addingDayIndex: null, 
                newActivity: { time: '', type: 'sight', title: '', desc: '', cost: '', location: '' },

                editingState: { dayIndex: null, activityIndex: null },
                tempEditActivity: { time: '', type: 'sight', title: '', desc: '', cost: '', location: '', tagsString: '' },

                newCategoryName: '',
                
                itinerary: JSON.parse(JSON.stringify(DEFAULT_ITINERARY)), 

                packingList: [
                    {
                        name: "重要證件 & 網路",
                        items: [
                            { name: "護照 (效期6個月+)", checked: false },
                            { name: "VJW 截圖 (入境用)", checked: false },
                            { name: "eSIM / 網卡設定", checked: false },
                            { name: "日幣現金 / 信用卡", checked: false }
                        ]
                    },
                    {
                        name: "衣物 & 穿搭 (1月均溫4度)",
                        items: [
                            { name: "發熱衣 (洋蔥式穿法)", checked: false },
                            { name: "防風大衣 / 羽絨衣", checked: false },
                            { name: "毛帽 & 手套 (玩雪用)", checked: false },
                            { name: "好走的防潑水鞋", checked: false }
                        ]
                    },
                    {
                        name: "隨身小物",
                        items: [
                            { name: "護唇膏 / 保濕乳液", checked: false },
                            { name: "行動電源", checked: false },
                            { name: "牙刷牙膏 (環保考量)", checked: false }
                        ]
                    }
                ],
                expenses: []
            }
        },
        mounted() {
            const savedData = localStorage.getItem('nagoyaTrip2026_v14'); // Updated version key
            if (savedData) {
                const parsed = JSON.parse(savedData);
                this.expenses = parsed.expenses || [];
                
                if(parsed.packingList && parsed.packingList.length > 0) {
                    this.packingList = parsed.packingList;
                }
                if (parsed.totalBudget) {
                    this.totalBudget = parsed.totalBudget;
                }
                if (parsed.itinerary && parsed.itinerary.length > 0) {
                    this.itinerary = parsed.itinerary;
                }
                if (parsed.tripTitle) {
                    this.tripTitle = parsed.tripTitle;
                }
            }
        },
        watch: {
            '$data': {
                handler(newValue) {
                    // Exclude UI state from saving (showSettings, temp vars)
                    const dataToSave = {
                        expenses: newValue.expenses,
                        packingList: newValue.packingList,
                        totalBudget: newValue.totalBudget,
                        itinerary: newValue.itinerary,
                        tripTitle: newValue.tripTitle
                    };
                    localStorage.setItem('nagoyaTrip2026_v14', JSON.stringify(dataToSave));
                },
                deep: true
            }
        },
        computed: {
            remainingBudget() {
                const spent = this.expenses.reduce((sum, item) => sum + item.amount, 0);
                return this.totalBudget - spent;
            },
            budgetProgress() {
                const spent = this.expenses.reduce((sum, item) => sum + item.amount, 0);
                if (this.totalBudget === 0) return 0;
                const percent = (spent / this.totalBudget) * 100;
                return percent;
            },
            checkListProgress() {
                let total = 0;
                let checked = 0;
                this.packingList.forEach(cat => {
                    cat.items.forEach(item => {
                        total++;
                        if (item.checked) checked++;
                    });
                });
                return total === 0 ? 0 : Math.round((checked / total) * 100);
            }
        },
        methods: {
            // --- Import / Export Feature ---
            exportData() {
                const dataToSave = {
                    expenses: this.expenses,
                    packingList: this.packingList,
                    totalBudget: this.totalBudget,
                    itinerary: this.itinerary,
                    tripTitle: this.tripTitle
                };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `nagoya_trip_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showSettings = false;
            },
            triggerImport() {
                this.$refs.fileInput.click();
            },
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if(confirm('確定匯入此檔案？目前的資料將被覆蓋。')) {
                            this.expenses = parsed.expenses || [];
                            this.packingList = parsed.packingList || this.packingList;
                            this.totalBudget = parsed.totalBudget || this.totalBudget;
                            this.itinerary = parsed.itinerary || this.itinerary;
                            this.tripTitle = parsed.tripTitle || this.tripTitle;
                            this.showSettings = false;
                            alert('匯入成功！');
                        }
                    } catch (err) {
                        alert('檔案格式錯誤，無法讀取。');
                    }
                };
                reader.readAsText(file);
                // Clear input
                event.target.value = '';
            },

            // --- Existing Methods ---
            startEditTitle() {
                this.tempTitle = this.tripTitle;
                this.isEditingTitle = true;
                this.$nextTick(() => {
                    if (this.$refs.titleInput) {
                        this.$refs.titleInput.focus();
                    }
                });
            },
            saveTitle() {
                if (this.tempTitle.trim()) {
                    this.tripTitle = this.tempTitle;
                }
                this.isEditingTitle = false;
            },
            cancelEditTitle() {
                this.isEditingTitle = false;
            },
            isEditing(dayIndex, activityIndex) {
                return this.editingState.dayIndex === dayIndex && this.editingState.activityIndex === activityIndex;
            },
            startEditActivity(dayIndex, activityIndex) {
                const activity = this.itinerary[dayIndex].activities[activityIndex];
                this.tempEditActivity = JSON.parse(JSON.stringify(activity));
                this.tempEditActivity.tagsString = activity.tags ? activity.tags.join(', ') : '';
                this.editingState = { dayIndex, activityIndex };
                this.addingDayIndex = null;
            },
            saveEditActivity() {
                if (this.tempEditActivity.tagsString && this.tempEditActivity.tagsString.trim() !== '') {
                    this.tempEditActivity.tags = this.tempEditActivity.tagsString.split(',').map(t => t.trim()).filter(t => t !== '');
                } else {
                    this.tempEditActivity.tags = [];
                }
                delete this.tempEditActivity.tagsString; 
                Object.assign(this.itinerary[this.editingState.dayIndex].activities[this.editingState.activityIndex], this.tempEditActivity);
                this.itinerary[this.editingState.dayIndex].activities.sort((a, b) => a.time.localeCompare(b.time));
                this.editingState = { dayIndex: null, activityIndex: null };
            },
            cancelEditActivity() {
                this.editingState = { dayIndex: null, activityIndex: null };
            },
            startAddActivity(dayIndex) {
                this.addingDayIndex = dayIndex;
                this.newActivity = { time: '09:00', type: 'sight', title: '', desc: '', cost: '', location: '' };
                this.cancelEditActivity(); 
            },
            cancelAddActivity() {
                this.addingDayIndex = null;
            },
            saveNewActivity(dayIndex) {
                if (!this.newActivity.title) {
                    alert('請輸入標題');
                    return;
                }
                const activity = { ...this.newActivity };
                const activities = this.itinerary[dayIndex].activities;
                activities.push(activity);
                activities.sort((a, b) => a.time.localeCompare(b.time));
                this.addingDayIndex = null;
            },
            deleteActivity(dayIndex, activityIndex) {
                if(confirm('確定刪除此行程？')) {
                    this.itinerary[dayIndex].activities.splice(activityIndex, 1);
                }
            },
            addItem(catIndex) {
                const category = this.packingList[catIndex];
                if (category.newItemInput && category.newItemInput.trim() !== '') {
                    category.items.push({
                        name: category.newItemInput.trim(),
                        checked: false
                    });
                    category.newItemInput = ''; 
                }
            },
            deleteItem(catIndex, itemIndex) {
                if(confirm('確定刪除此項目？')) {
                    this.packingList[catIndex].items.splice(itemIndex, 1);
                }
            },
            addCategory() {
                if (this.newCategoryName && this.newCategoryName.trim() !== '') {
                    this.packingList.push({
                        name: this.newCategoryName.trim(),
                        items: [],
                        newItemInput: ''
                    });
                    this.newCategoryName = '';
                }
            },
            deleteCategory(catIndex) {
                if(confirm(`確定刪除整個「${this.packingList[catIndex].name}」分類及其所有項目？`)) {
                    this.packingList.splice(catIndex, 1);
                }
            },
            startEditBudget() {
                this.tempBudget = this.totalBudget;
                this.isEditingBudget = true;
                this.$nextTick(() => {
                    if (this.$refs.budgetInput) {
                        this.$refs.budgetInput.focus();
                    }
                });
            },
            saveBudget() {
                if (this.tempBudget > 0) {
                    this.totalBudget = this.tempBudget;
                }
                this.isEditingBudget = false;
            },
            getDotColor(type) {
                const colors = {
                    transport: 'bg-blue-500 border-blue-100',
                    food: 'bg-orange-500 border-orange-100',
                    sight: 'bg-green-500 border-green-100',
                    shopping: 'bg-pink-500 border-pink-100',
                    stay: 'bg-purple-500 border-purple-100'
                };
                return colors[type] || 'bg-gray-400';
            },
            getBarColor(type) {
                const colors = {
                    transport: 'bg-blue-500',
                    food: 'bg-orange-500',
                    sight: 'bg-green-500',
                    shopping: 'bg-pink-500',
                    stay: 'bg-purple-500'
                };
                return colors[type] || 'bg-gray-300';
            },
            toggleCheck(cIndex, iIndex) {
                this.packingList[cIndex].items[iIndex].checked = !this.packingList[cIndex].items[iIndex].checked;
            },
            addExpense() {
                if (!this.newExpense.title || !this.newExpense.amount) return;
                const today = new Date();
                const dateStr = `${today.getMonth()+1}/${today.getDate()} ${today.getHours().toString().padStart(2,'0')}:${today.getMinutes().toString().padStart(2,'0')}`;
                
                this.expenses.unshift({
                    title: this.newExpense.title,
                    amount: this.newExpense.amount,
                    date: dateStr
                });
                this.newExpense.title = '';
                this.newExpense.amount = '';
            },
            quickAddExpense(title) {
                this.newExpense.title = title;
                this.currentTab = 'wallet';
            },
            removeExpense(index) {
                if(confirm('確定刪除這筆紀錄？')) {
                    this.expenses.splice(index, 1);
                }
            },
            resetData() {
                if(confirm('確定重置所有資料 (包含清單、預算與行程)？\n\n注意：這會將行程恢復為預設值。')) {
                    localStorage.removeItem('nagoyaTrip2026_v14');
                    location.reload();
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
